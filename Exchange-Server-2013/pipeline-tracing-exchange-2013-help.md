---
title: 'パイプライン トレース: Exchange 2013 Help'
TOCTitle: パイプライン トレース
ms:assetid: e7780499-9a6f-48b1-aea8-df88ecd8b18a
ms:mtpsurl: https://technet.microsoft.com/ja-jp/library/Bb125018(v=EXCHG.150)
ms:contentKeyID: 52057870
ms.date: 04/24/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# パイプライン トレース

 

_**適用先:** Exchange Server 2013_

_**トピックの最終更新日:** 2015-03-09_

パイプライン トレースは、特定の送信者からの電子メール メッセージが、メールボックス サーバーのトランスポート サービス、メールボックス サーバーのメールボックス トランスポート配信サービス、およびエッジ トランスポート サーバーを経由したときに、それらのコピーをキャプチャします。パイプライン トレースは、各トランスポート エージェントがメッセージ スナップショット ファイル内のトランスポート パイプラインのメッセージに適用した変更について詳細な情報をキャプチャします。メッセージ スナップショット ファイルの内容を調べると、トランスポート エージェントによって、期待したトランスポート パイプライン内のメッセージに変更が加えられたかどうかを確認することができます。問題のトラブルシューティングを行う場合は、どのトランスポート エージェントに問題があるのかを確認する必要があります。次に、トラブルシューティングの対象をそのエージェントに絞って問題を解決します。その後、メッセージ スナップショット ファイルを再び表示すると、ソリューションが成功したことを確認できます。


> [!NOTE]
> <UL>
> <LI>
> <P>パイプライン トレースでは、送信者の電子メール アドレスから送信された電子メール メッセージの内容が完全にコピーされます。機密情報の不要な公開を防ぐには、パイプライン トレース フォルダーに対して適切なセキュリティのアクセス許可を設定する必要があります。</P>
> <LI>
> <P>パイプライン トレースを長時間にわたって有効にしないでください。パイプライン トレースではファイルが作成され、すぐに蓄積されます。パイプライン トレースを有効にしている場合は、使用可能なディスクの空き領域を常に監視してください。</P></LI></UL>



## パイプライン トレースを構成する

パイプライン トレースを有効にする前に、監視する送信者の電子メール アドレスを指定する必要があります。パイプライン トレースは、特定の電子メール アドレスから送信されたメッセージをログに記録するように設計されています。送信者の電子メール アドレスは Exchange 組織の内部または外部のどちらでもかまいません。別の方法として、自動応答、配信状態通知 (DSN) メッセージ、ジャーナル レポート、およびその他のシステムが生成したメッセージなど、指定したメールボックス サーバーまたはエッジ トランスポート サーバーのトランスポート サービスによって生成されたシステムメッセージに対してパイプライン トレースを有効にすることができます。また、パイプライン トレース フォルダーの場所を変更することもできます。

パイプライン トレースを構成するために使用するパラメーターを次の表に要約しています。


<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>コマンドレット</th>
<th>パラメーター</th>
<th>既定値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>PipelineTracingSenderAddress</em></p></td>
<td><p>空白 (<code>$null</code>)</p></td>
<td><p>監視する送信者の電子メール アドレスを指定します。</p>
<p>指定したサーバー上のトランスポート サービスによって送信されたシステム生成メッセージを監視するための値 &quot;&lt;&gt;&quot; を指定します。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>PipelineTracingPath</em></p></td>
<td><p><strong>トランスポート サービス</strong> <code>%ExchangeInstallPath%TransportRoles\Logs\Hub\PipelineTracing</code></p>
<p><strong>メールボックス トランスポート サービス</strong> <code>%ExchangeInstallPath%TransportRoles\Logs\Mailbox\PipelineTracing</code></p></td>
<td><p>パスは、ローカル サーバーにする必要があります。UNC パスはサポートされていません。</p>
<p>指定したパスには、パイプライン トレース ファイルが格納される <code>MessageSnapshots</code> フォルダーが含まれます。</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>PipelineTracingEnabled</em></p></td>
<td><p><code>$false</code></p></td>
<td><p>監視する送信者のアドレスを構成した後は、指定したサーバー上のトランスポート サービスに対してのみパイプライン トレースを有効にすることができます。</p></td>
</tr>
</tbody>
</table>


パイプライン トレースを有効化し、パイプライン トレースの送信者アドレスを構成する方法の詳細については、「[パイプライン トレースを構成する](configure-pipeline-tracing-exchange-2013-help.md)」を参照してください。

## メッセージ スナップショット ファイル

メッセージ スナップショットは、トランスポート サービスまたはメールボックス トランスポート配信サービスでトランスポート エージェントによってメッセージに加えられた変更をキャプチャするファイルです。これらのファイルは、トランスポート サービスの対応するパイプライン トレース パス内の `MessageSnapshots` フォルダーに格納されます。

`MessageSnapshots` フォルダーには、Exchange によって、監視された送信者が送信し、指定したトランスポート サービスを経由したメッセージごとにフォルダーが作成されます。各フォルダー名は、メッセージに割り当てられる GUID に基づいて付けられます。同じメールボックス サーバー上のトランスポート サービスとメールボックス トランスポート サービスに対してパイプライン トレースを有効にすると、各トランスポート サービスによって同じメッセージに異なる GUID が割り当てられるため、トランスポート サービスの `MessageSnapshots` フォルダー内のメッセージのフォルダー名とメールボックス トランスポート サービスの `MessageSnapshots` フォルダー内の同じメッセージのフォルダー名は異なります。複数の Exchange サーバー上でパイプライン トレースを有効にしている場合、各 Exchange サーバーで指定されたトランスポート サービスを経由するため、同じメッセージに異なる GUID が割り当てられます。

Exchange によって、各メッセージ フォルダー内に, .eml 拡張子が付いた複数のメッセージ スナップショット ファイルが作成されます。これらのメッセージ スナップショット ファイルには、各 SMTP イベントおよびトランスポート エージェントの検出時におけるメッセージの内容が含まれます。

SMTP イベントに対してトランスポート エージェントが登録されると、メッセージが任意のトランスポート エージェントを検出する前に、Exchange によってメッセージのメッセージ スナップショットが作成されます。これにより、メッセージがそのイベントに対して登録されているトランスポート エージェントを検出する前に、メッセージがコピーされます。次に、トランスポート エージェントによってメッセージの内容が変更されるかどうかにかかわらず、メッセージが検出したトランスポート エージェントごとに新しいメッセージ スナップショットが作成されます。ただし、イベントに登録されているエージェントがない場合は、Exchange によってそのイベントのメッセージ スナップショットは作成されません。

たとえば、**OnEndofData** イベントに 3 つのエージェントが登録されているにもかかわらず、2 つのトランスポート エージェントのみがメッセージを変更する場合は、4 つのメッセージ スナップショットが作成されます。1 つ目のメッセージ スナップショットでは、**OnEndofData** イベントに登録されているトランスポート エージェントによって変更が加えられる前に、そのイベントの検出時にメッセージを取得します。その後、トランスポート エージェントによってメッセージが変更されるかどうかにかかわらず、トランスポート エージェントごとにメッセージ スナップショットが 1 つずつ作成されます。

作成されるメッセージ スナップショット ファイルを次のリストで説明します。

  - **Original.eml**   このファイルには、SMTP イベントまたはトランスポート エージェントを検出する前の、電子メール メッセージの元の変更されていない内容が含まれます。

  - **Routingnnnn.eml**   これらのファイルには、トランスポート サービスの分類部分で SMTP イベントとそれらのイベントに登録されたトランスポート エージェントが検出された場合の、電子メール メッセージの内容が含まれます。プレースホルダー *nnnn* は、`0001` で始まる正数値を表します。値は、SMTP イベントとそれらのイベントに登録されたトランスポート エージェントがメッセージに影響を及ぼした順序で、イベントとエージェントごとに増分されます。メールボックス トランスポート配信サービスは、これらの**Routing** スナップショット ファイルを生成しません。

  - **SmtpReceivennnn.eml**   これらのファイルには、SMTP がトランスポート サービスまたはメールボックス トランスポート配信サービスを受信しているときに、**OnEndofData** および **OnEndOfHeaders** SMTP イベントとそれらのイベントに登録されたトランスポート エージェントが検出された場合の、電子メール メッセージの内容が含まれます。プレースホルダー *nnnn* は、`0001` で始まる正数値を表します。値は、SMTP イベントとそれらのイベントに登録されたトランスポート エージェントがメッセージに影響を及ぼした順序で、イベントとエージェントごとに増分されます。

メッセージ スナップショット ファイルは、メモ帳や任意のテキスト エディターを使用して開くことができます。

各メッセージ スナップショット ファイルの先頭には、メッセージの本文に追加されているヘッダーと、そのメッセージ スナップショット ファイルが関連付けられている SMTP イベントおよびトランスポート エージェントの一覧が含まれます。これらのヘッダーは、先頭に `X-CreatedBy: MessageSnapshot-Begin injected headers`、末尾に `X-EndOfInjectedXHeaders: MessageSnapshot-End injected headers` が付きます。これらのヘッダーは、以降のトランスポート エージェントと SNMP イベントによって、各メッセージ スナップショット ファイル内で置き換えられます。以下に、電子メール メッセージ ファイルに追加されるヘッダーの例を示します。

  ```powershell
  X-CreatedBy: MessageSnapshot-Begin injected headers
  X-MessageSnapshot-UTC-Time: 2013-01-23T23:20:18.138Z
  X-MessageSnapshot-Record-Id: 21474836486
  X-MessageSnapshot-Source: OnSubmittedMessageX-Sender: michelle@nwtraders.com
  X-Receiver: chris@contoso.com
  X-EndOfInjectedXHeaders: MessageSnapshot-End injected headers
  ```

ファイルには、メッセージ スナップショット ヘッダーの後に、元のメッセージ ヘッダーのすべてを含む、メッセージの内容が含まれます。トランスポート エージェントによってメッセージの内容が変更される場合は、その変更内容がメッセージに統合されて表示されます。各トランスポート エージェントによってメッセージが処理されるときに、各エージェントによって加えられる変更内容がメッセージの内容に適用されます。トランスポート エージェントによってメッセージの内容に加えられる変更がない場合は、そのエージェントによって作成されるメッセージ スナップショットは、前のトランスポート エージェントによって作成されたメッセージ スナップショットと同じになります。

