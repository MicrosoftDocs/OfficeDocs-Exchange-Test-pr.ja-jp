---
title: 'メッセージ調整: Exchange 2013 Help'
TOCTitle: メッセージ調整
ms:assetid: fba87902-2a79-42ac-b394-46a9016f667e
ms:mtpsurl: https://technet.microsoft.com/ja-jp/library/Bb232205(v=EXCHG.150)
ms:contentKeyID: 49896563
ms.date: 04/24/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# メッセージ調整

 

_**適用先:** Exchange Server 2013_

_**トピックの最終更新日:** 2015-03-09_

*メッセージ調整*は、Microsoft Exchange Server 2013 コンピューターで処理可能なメッセージ数および接続数に対して設定される制限のグループです。これらの制限により、Exchange サーバーのシステム リソースを偶然または意図的に使い果たしてしまうのを防ぐことができます。

**目次**

メッセージ調整の範囲について

メッセージ コストとメール フローの調整

サーバーでのメッセージ調整

送信コネクタでのメッセージ調整

受信コネクタでのメッセージ調整

メッセージ調整ポリシー

## メッセージ調整の範囲について

メッセージ調整は、メッセージ処理速度、SMTP 接続速度、および SMTP セッション タイムアウト値に対するさまざまな制限を含みます。これらの制限を組み合わせて適用することにより、メッセージの受け付けおよび配信によって Exchange サーバーに過剰な負担がかかるのを防ぐことができます。メッセージ調整の制限を適用すると、処理を待つメッセージおよび接続の大量のバックログが発生しても、Exchange サーバーはそれらのメッセージや接続を適正な方法で処理できます。

メッセージ調整に加えて、受信者数、メッセージ ヘッダーのサイズ、個々の添付ファイルのサイズなど、メッセージの個々の要素に対してサイズ制限を設定することもできます。メッセージ サイズの制限の詳細については、「[メッセージ サイズの制限](message-size-limits-exchange-2013-help.md)」を参照してください。

Exchange トランスポート サーバーのシステム リソースに過剰な負担がかかるのを防ぐために役立つもう 1 つの機能は、*バック プレッシャー*です。バック プレッシャーは、メールボックス サーバー上およびエッジ トランスポート サーバー上のトランスポート サービスのシステム リソース監視機能です。ハード ディスク使用率やメモリ使用率などの監視対象システム リソースが、指定されたしきい値を超えると、サーバーは新しい接続やメッセージを受け付ける速度を落とし、既存のメッセージの配信に集中します。監視対象システム リソースの使用率が標準レベルに戻ると、サーバーは新しい接続を受け付ける速度を徐々に上げ、通常のレベルを確立します。

ページのトップへ

## メッセージ コストとメール フローの調整

より一貫性のあるメッセージ スループットと予測可能なメッセージ配信の待機時間を実現するために、Exchange 2013 では、メッセージの累計コストを定めています。この QoS (Quality of Service) 機能は、Microsoft Exchange Server 2010 SP1 で追加されました。このコストは、次の条件に基づいています。

  - \[メッセージ サイズ\]

  - 受信者の数

  - 送信頻度

Exchange 2013 トランスポート サーバーは、各ユーザーが送信するメッセージの平均配信コストを追跡記録します。メッセージ コストを使用することで、Exchange 2013 はユーザーまたは接続が Exchange 組織に与える影響を制御できる設定のグループを提供します。この設定のグループは、*調整ポリシー*と呼ばれます。サイズの大きなファイルが添付されたメッセージや、多数の受信者に送信されるメッセージなどのコストの高いメッセージをユーザーが繰り返し送信すると、Exchange 2013 ベースのトランスポート サーバーが調整ポリシーを使用して、ユーザーからのコストの高いメッセージに低い優先度を割り当てる一方で、コストの低いメッセージの配信を続行します。この新しい動作によって、Exchange 2013 のメッセージ調整機能に「QoS」の側面が追加されます。


> [!NOTE]
> メッセージ調整は、ユーザーの観点に基づくメッセージの優先度には影響しません。メッセージは、ユーザーが設定した元の優先度を保持します。たとえば、重要または緊急などのメッセージに関する設定は維持されます。



この機能をサポートするために、Exchange 2013 では次のメカニズムを使用しています。

  - **内部優先付けエージェント** このエージェントは、**OnResolvedMessage** イベント発生時にトリガーされ、累積コストが高い送信者からのメッセージに低い優先度を割り当てます。このコストは、1 分間にわたって測定され、500 名以上の受信者が指定してあるか、1 メガバイト (MB) より大きいメッセージに影響します。

  - **MapiDelivery キュー タイプ向けのクォータベースの優先度キュー** このメカニズムは、Exchange が優先度の低いキューに入っているメッセージよりも、優先度が標準のキューに入っているメッセージのほうをより頻繁に配信するようにします。既定では、優先度が標準のメッセージと低いメッセージの比率は、20:1 です。ただし、優先度の低いキューにある新しいメッセージが、優先度の高いキューにある新しいメッセージよりも早く配信されることはありません。たとえば、次のシナリオを考えてみてください。
    
    1.  優先度が標準のメッセージが 20 通配信されます。既定では、次に配信されるメッセージは、優先度の低いメッセージです。
    
    2.  トランスポート サーバーが 2 通の新しいメッセージを受信します。1 通のメッセージは優先度の低いキューから、もう 1 通は優先度の高いキューから配信されたものです。
    
    このシナリオでは、優先度の高いメッセージが最初に配信されます。その後、優先度のより低いキューからメッセージが配信されます。

  - **メッセージング データベースの状態に基づいた同時接続の調整**   このメカニズムは Exchange メッセージング データベース (MDB) の状態を監視し、Exchange トランスポート サーバーへの同時接続を割り当てられた状態測定値に基づいて調整します。MDB は、メールボックス サーバー上のトランスポート サービスのリソース状態監視 API によって監視され、-1 から 100 までの状態値が割り当てられます。この値は、メールボックス トランスポート サービス内の Store.exe プロセスからの RPC 応答ごとに含まれている RPC パフォーマンス統計に基づいています。リソース状態フレームワークが、**Requests/Second** 速度パフォーマンス カウンターと **Average RPC Latency** パフォーマンス カウンターの両方を使用してデータベースの状態の値を計算します。ユーザーの対話型操作の一貫性を維持するために、Exchange は、状態の値が低下するに従って、同時接続の数を減らします。状態値には次の範囲があります。
    
      - **-1:**  この値は、MDB の状態が不明であることを示します。この値は、データベースの開始時に割り当てられます。このシナリオでは、データベースは正常であると見なされます。
    
      - **0:**  この値は、データベースの状態に異常がある場合に割り当てられます。この状態では、データベースに接続してはなりません。
    
      - **1 ～ 99:**  これらの値は、状態に問題がないことを表します。値が小さいほどデータベースの状態は悪くなります。
    
      - **100:**  この値は、データベースが正常であることを表します。

Microsoft Exchange 調整サービスは、メール フロー調整のフレームワークを提供します。Microsoft Exchange 調整サービスは、特定のユーザーのメール フロー調整設定を追跡し、メモリー内に調整情報をキャッシュします。メール フロー調整の設定は、*バジェット*とも呼ばれます。Microsoft Exchange 調整サービスを再起動すると、メール フロー調整バジェットもリセットされます。

Exchange 2013 で利用可能な調整ポリシー コマンドレットを使用して、調整ポリシーの個別のバジェット設定を実行できます。バジェットとは、特定の設定に対してユーザーまたはアプリケーションが保有するアクセス数のことです。このバジェットは、1 分間にユーザーが保持できる接続数、または許可されるアクティビティ数を表します。たとえば、ユーザーが ActiveSync、Outlook Web App、または Exchange Web サービスなどの Exchange の特定の機能を使用できる時間を設定するのにバジェットを使用できます。このしきい値は調整ポリシーに格納され、バジェットを定義します。

バジェットの時間設定は、1 分間の割合として設定されます。したがって、しきい値が 100% の場合は 60 秒を表します。たとえば、ユーザーがクライアント アクセス サーバー上で Outlook Web App コードを実行できる時間の長さや、ユーザーがクライアント アクセス サーバーと通信できる時間の長さを 1 分間のうち 600 ミリ秒に制限する Outlook Web App ポリシー設定を指定するとします。これを行うには、次のパラメーターの両方の値を 1 分間の 1% (600 ミリ秒) に設定する必要があります。

  - **OWAPercentTimeInCAS**:1

  - **OWAPercentTimeInMailboxRPC**:1

このポリシーが適用されるユーザーのバジェットのパラメーター、OWAPercentTimeInCAS が 600 ミリ秒、OWAPercentageTimeInMailboxRPC が 600 ミリ秒であるとします。このシナリオでは、ユーザーが Outlook Web App にログインすると、ユーザーは最大 600 ミリ秒間、クライアント アクセス コードを実行できます。600 ミリ秒が過ぎると、接続のバジェットが超過したと見なされ、Exchange サーバーは、バジェットの制限に達した後 1 分が経過するまで Outlook Web App の以降のアクションを禁止します。1 分経過したら、ユーザーは Outlook Web App クライアント アクセス コードを再度 600 ミリ秒間実行できます。

ページのトップへ

## サーバーでのメッセージ調整

メッセージ調整オプションは、次の場所で設定できます。

  - トランスポート サービス

  - 送信コネクタ

  - 受信コネクタ

メールボックス サーバーのトランスポート サービス、メールボックス サーバーのメールボックス トランスポート サービス、またはクライアント アクセス サーバーのフロント エンド トランスポート サービスで使用できるすべてのメッセージ調整オプションは、Exchange 管理シェルで設定できます。また、一部の同じオプションは、Exchange 管理センター (EAC) のトランスポート サーバーのプロパティを構成して設定することもできます。

次の表は、トランスポート サーバーで使用できるメッセージ調整オプションを示しています。

### トランスポート サーバーのメッセージ調整オプション

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>ソース</th>
<th>パラメーター</th>
<th>既定値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>MaxConcurrentMailboxDeliveries</em></p></td>
<td><p>20</p></td>
<td><p>このパラメーターには、メッセージをメールボックスに配信するためにトランスポート サービスが同時に開くことができる配信スレッドの最大数を指定します。このパラメーターの有効な入力範囲は 1 ～ 256 です。Microsoft カスタマー サービスおよびサポートからの指示がない限り、この既定値を変更しないことをお勧めします。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>MaxConcurrentMailboxSubmissions</em></p></td>
<td><p>20</p></td>
<td><p>このパラメーターには、メッセージをメールボックスから送信するためにトランスポート サービスが同時に開くことができる発信スレッドの最大数を指定します。このパラメーターの有効な入力の範囲は、1 ～ 256 です。</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p></td>
<td><p><em>MaxConnectionRatePerMinute</em></p></td>
<td><p>1200</p></td>
<td><p>このパラメーターには、トランスポート サービスで開くことができる接続の最大数を指定します。トランスポート サービスで同時に多数の接続が試行される場合、<em>MaxConnectionRatePerMinute</em> パラメーターは開かれる接続数を制限し、サーバーのリソースに過剰な負担がかからないようにします。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong> または</p>
<p>トランスポート サーバーのプロパティ</p></td>
<td><p><em>MaxOutboundConnections</em></p></td>
<td><p>1000</p></td>
<td><p>このパラメーターは、同時に開くことができる送信接続の最大数を指定します。<code>unlimited</code> という値を入力した場合、送信接続数は制限されません。このパラメーターの値は、<em>MaxPerDomainOutboundConnections</em> パラメーターの値以上である必要があります。</p>
<p>EAC で <strong>[サーバー]</strong> &gt; <strong>[サーバー]</strong> &gt; <strong>[プロパティ]</strong> &gt; <strong>[Transport limits (トランスポート制限)]</strong> &gt; <strong>[Outbound connection restrictions (送信接続の制約事項)]</strong> を使用して、この値を構成することもできます。</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-TransportService</strong> または</p>
<p>トランスポート サーバーのプロパティ</p></td>
<td><p><em>MaxPerDomainOutboundConnections</em></p></td>
<td><p>20</p></td>
<td><p>このパラメーターは、単一のドメインへの同時接続の最大数を指定します。<code>unlimited</code> という値を入力した場合、ドメインごとの送信接続数は制限されません。このパラメーターの値は、<em>MaxOutboundConnections</em> パラメーターの値以上である必要があります。</p>
<p>EAC で <strong>[サーバー]</strong> &gt; <strong>[サーバー]</strong> &gt; <strong>[プロパティ]</strong> &gt; <strong>[Transport limits (トランスポート制限)]</strong> &gt; <strong>[Outbound connection restrictions (送信接続の制約事項)]</strong> を使用して、この値を構成することもできます。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong></p></td>
<td><p><em>PickupDirectoryMaxMessagesPerMinute</em></p></td>
<td><p>100</p></td>
<td><p>このパラメーターには、ピックアップ ディレクトリおよび再生ディレクトリによって 1 分あたりに処理されるメッセージの最大数を指定します。各ディレクトリは、このパラメーターで指定された処理速度でそれぞれ独立してメッセージを処理できます。</p></td>
</tr>
</tbody>
</table>


ページのトップへ

## 送信コネクタでのメッセージ調整

次の表は、送信コネクタで使用できるメッセージ調整オプションを示しています。このオプションを構成するには、Exchange 管理シェルを使用する必要があります。

### 送信コネクタ上で利用可能なメッセージ調整オプション

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>ソース</th>
<th>パラメーター</th>
<th>既定値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-SendConnector</strong></p></td>
<td><p><em>ConnectionInactivityTimeOut</em></p></td>
<td><p>10 分</p></td>
<td><p>このパラメーターには、送信先のメッセージング サーバーとの SMTP 接続をアイドル状態のまま開いておくことができる時間の上限を指定します。この上限に達すると接続は閉じられます。</p></td>
</tr>
</tbody>
</table>


ページのトップへ

## 受信コネクタでのメッセージ調整

次の表に、メールボックス サーバー上またはエッジ トランスポート サーバー上のトランスポート サービスで構成されている受信コネクタで使用できるメッセージ調整オプションを示します。これらのオプションを構成するには、Exchange 管理シェルを使用する必要があります。

### 受信コネクタ上で利用可能なメッセージ調整オプション

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>ソース</th>
<th>パラメーター</th>
<th>既定値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>ConnectionInactivityTimeOut</em></p></td>
<td><p>メールボックス サーバー上のトランスポート サービスで 5 分</p>
<p>クライアント アクセス サーバー上のフロント エンド トランスポート サービスで 5 分。</p>
<p>エッジ トランスポート サーバーで 1 分。</p></td>
<td><p>このパラメーターには、送信元のメッセージング サーバーとの SMTP 接続をアイドル状態のまま開いておくことができる時間の上限を指定します。この上限に達すると接続は閉じられます。このパラメーターの値は、<em>ConnectionTimeout</em> パラメーターによって指定される値未満にする必要があります。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>ConnectionTimeOut</em></p></td>
<td><p>メールボックス サーバー上のトランスポート サービスで 10 分</p>
<p>クライアント アクセス サーバー上のフロント エンド トランスポート サービスで 10 分。</p>
<p>エッジ トランスポート サーバーで 5 分。</p></td>
<td><p>このパラメーターには、送信元のメッセージング サーバーとの SMTP 接続を開いておくことができる時間の上限を指定します。この制限は、送信元のメッセージング サーバーがデータを転送していても適用されます。このパラメーターの値は、<em>ConnectionInactivityTimeout</em> パラメーターによって指定される値より大きくする必要があります。</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxInboundConnection</em></p></td>
<td><p>5000</p></td>
<td><p>このパラメーターには、この受信コネクタが同時に許容する受信 SMTP 接続の最大数を指定します。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxInboundConnectionPercentagePerSource</em></p></td>
<td><p>メールボックス サーバー上のトランスポート サービスの既定受信コネクタで 100%</p>
<p>メールボックス サーバー上のトランスポート サービスおよびクライアント アクセス サーバー上のフロント エンド トランスポート サービスの他の受信コネクタで 2%</p></td>
<td><p>このパラメーターには、受信コネクタが同時に許容する、単一の送信元メッセージング サーバーからの SMTP 接続の最大数を指定します。値は受信コネクタで利用可能な残っている接続の割合で表します。受信コネクタが許容する接続の最大数は、<em>MaxInboundConnection</em> パラメーターで定義されます。</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxInboundConnectionPerSource</em></p></td>
<td><p>メールボックス サーバー上のトランスポート サービスの既定受信コネクタで unlimited</p>
<p>メールボックス サーバー上のトランスポート サービスおよびクライアント アクセス サーバー上のフロント エンド トランスポート サービスの他の受信コネクタで 20</p></td>
<td><p>このパラメーターには、受信コネクタが同時に許容する、単一の送信元メッセージング サーバーからの SMTP 接続の最大数を指定します。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxProtocolErrors</em></p></td>
<td><p>5</p></td>
<td><p>このパラメーターには、受信コネクタが送信元メッセージング サーバーとの接続を閉じるまでに許容する SMTP プロトコル エラーの最大数を指定します。</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>TarpitInterval</em></p></td>
<td><p>5 秒</p></td>
<td><p>このパラメーターには、<em>タールピット</em>で使用される遅延を指定します。タールピットとは、ディレクトリ獲得攻撃や他の望ましくないメッセージを示す特定の SMTP 通信パターンに対して、SMTP の応答を意図的に遅延させる方法です。<em>ディレクトリ獲得攻撃</em>とは、迷惑な商用電子メールのターゲットとして利用するために、特定の組織から有効な電子メール アドレスを収集しようとする試みです。</p>
<p><em>TarpitInterval</em> パラメーターで指定した遅延は、匿名接続にのみ適用されます。</p></td>
</tr>
</tbody>
</table>


ページのトップへ

## メッセージ調整ポリシー

Exchange 2013 では、メールボックスごとに *ThrottlingPolicy* 設定が行われます。この設定の既定値はブランク (`$null`) です。**Set-Mailbox** コマンドレットの *ThrottlingPolicy* パラメーターを使用して、メールボックスに調整ポリシーを設定できます。

Exchange に接続するユーザー向けにバジェット設定の既定のセットを提供する、既定の調整ポリシーが存在します。1 人以上のユーザー用にバジェット設定をカスタマイズするには、新しい調整ポリシーを作成します。次に、適切なユーザーまたはグループにポリシーを適用します。


> [!IMPORTANT]
> 既定の調整ポリシーを変更しないことをお勧めします。



メールボックス サーバーで使用できるすべてのメッセージ調整オプションは、Exchange 管理シェルで設定できます。次のコマンドレットを利用して、調整ポリシーを管理できます。

  - **Get-ThrottlingPolicy**

  - **Remove-ThrottlingPolicy**

  - **New-ThrottlingPolicy**

  - **Set-ThrottlingPolicy**

**New-ThrottlingPolicy** および **Set-ThrottlingPolicy** コマンドレットを使用して、ユーザーが Exchange に対して、特定の接続または時間内に実行できるアクティビティ数を設定できます。これらの設定がユーザーのバジェットを構成します。次の Exchange 機能へのアクセスを制御するために、調整ポリシーを構築できます。

  - Exchange ActiveSync

  - Exchange Web サービス

  - Outlook Web App

  - ユニファイド メッセージング

  - IMAP4

  - POP3

  - Outlook クライアント接続 (MAPI または RPC 接続)

  - メール フローの設定

  - PowerShell コマンド

  - CPU の使用状況

ページのトップへ

