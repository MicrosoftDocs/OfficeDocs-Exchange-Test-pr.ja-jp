---
title: '以前のバージョンと比較した高可用性とサイト復元の変更点: Exchange 2013 Help'
TOCTitle: 以前のバージョンと比較した高可用性とサイト復元の変更点
ms:assetid: de53c00b-091c-4a31-aacc-1bd40c756ce2
ms:mtpsurl: https://technet.microsoft.com/ja-jp/library/Dn789066(v=EXCHG.150)
ms:contentKeyID: 62519732
ms.date: 05/23/2018
mtps_version: v=EXCHG.150
ms.translationtype: MT
---

# 以前のバージョンと比較した高可用性とサイト復元の変更点

 

_**適用先:** Exchange Server 2013 SP1_

_**トピックの最終更新日:** 2015-04-07_

Exchange 2013 では DAG およびメールボックス データベース コピーのほか、単一アイテム回復、アイテム保持ポリシー、時間差データベース コピーなどの他の機能を使用して、高可用性、サイトの復元、および Exchange ネイティブ データ保護を実現しています。高可用性プラットフォーム、Exchange Information Store、および Extensible Storage Engine (ESE) がすべて改善され、可用性と管理のしやすさが向上し、コストが低下しました。以下のような点が改善されました。

  - **Exchange 2010 と比較した IOPS の減少**   これにより、容量および IOPS の点でより大きいディスクを活用して効率を最大限に高めています。

  - **可用性管理**   可用性管理によって内部監視機能および回復指向の機能が緊密に統合され、障害の未然防止、サービスの予防的復元、サーバー フェールオーバーの自動開始に役立つほか、管理者にアクションを実行するよう警告を出すこともできます。サーバーとコンポーネントの稼動時間だけでなく、エンドユーザー エクスペリエンスの監視および管理に重点を当てることで、サービスを継続的に利用できるようにしています。

  - **管理ストア**   管理ストアが、Exchange 2013 での新しく書き換えられた Information Store プロセスの名前です。新しい管理ストアは C\# で作成されて Microsoft Exchange Replication サービス (MSExchangeRepl.exe) に緊密に統合されているため、回復性が向上し、可用性がより高くなっています。

  - **ディスクごとに複数のデータベースをサポート** Exchange 2013 には同一ディスク上で複数のデータベース (アクティブ コピーとパッシブ コピーの混在) をサポートする拡張機能が含まれています。大容量で IOPS が高速のディスクを活用して効率を最大限に高めています。

  - **AutoReseed**   自動再シード機能により、ディスク障害後、データベースの冗長性を迅速に回復できます。ディスクに障害が発生した場合、そのディスクに格納されているデータベース コピーが、アクティブ データベース コピーから同じサーバー上の予備ディスクにコピーされます。障害が発生したディスクに複数のデータベース コピーが格納されていた場合は、予備ディスク上に自動的に再シードされます。この結果、アクティブ データベースが複数のサーバーに存在し、データが並行してコピーされるので、迅速に再シードできます。

  - **ストレージ障害から自動回復**   この機能は Exchange 2010 で導入された新機能です。この機能により、回復能力または冗長性に影響を与える障害からシステムが回復できます。Exchange 2013 は、Exchange 2010 バグチェックの動作に加え、MSExchangeRepl.exe による長時間の入出力と過剰なメモリ消費、さらにスレッドがスケジュール不可能になるような、システムが不良状態となる重大な状況のための追加の回復動作を備えています。

  - **時間差コピーに対する機能拡張**   時間差コピーは自動的なログ再生を使用することにより、一定の範囲まで自身を管理できるようになりました。時間差コピーでは、ページ パッチ、低ディスク容量のようなさまざまな状況で、ログ ファイルを自動的に再生します。時間差コピーに対してページ パッチが必要であることが検知されると、ログが自動的に時間差コピーに対して再生され、ページ パッチが実行されます。時間差コピーでは、低ディスク容量のしきい値に達した場合、および時間差コピーが特定の時間帯において唯一の利用可能なコピーであると検知された場合にも、この自動再生機能が呼び出されます。また、時間差コピーではセーフティ ネットを利用して、より簡単に回復やアクティブ化を行うことができます。

  - **単一コピーの警告の機能強化** Exchange 2010 で導入された単一コピーの警告は、独立したスケジュールされたスクリプトではなくなりました。この機能は、システム内の可用性管理コンポーネントに統合され、Exchange のネイティブな機能になりました。

  - **DAG ネットワークの自動構成**   DAG ネットワークは、構成設定を基にして、システムにより自動的に構成できます。手動構成オプションに加え、DAG で MAPI とレプリケーション ネットワークを区別して DAG ネットワークを自動的に構成することも可能です。

## Exchange 2010 と比較した IOPS の減少

Exchange 2010 では、パッシブ データベース コピーのチェックポイントの深さは、高速なフェールオーバーで必要となるために非常に低くなっています。さらに、パッシブ コピーは 5 MB のチェックポイントの深さを維持するためにデータの積極的な事前読み込みを実行します。低いチェックポイントの深さを使用し、これらの積極的な事前読み込み処理を行った結果、パッシブ データベース コピーに対する IOPS は Exchange 2010 のアクティブ コピーに対する IOPS と同等になりました。

Exchange 2013 では、システムはパッシブ コピー (100 MB) で高いチェックポイントの深さを使用したまま、高速なフェールオーバーを提供できます。パッシブ コピーのチェックポイントの深さは 100 MB のため、もはや積極的ではないレベルまで緩和されました。チェックポイントの深さを増やし、積極的な事前読み込みを緩和した結果、パッシブ コピーに対する IOPS は Exchange 2013 のアクティブ コピー IOPS の約 50% です。

パッシブ コピーのチェックポイントの深さをより高く設定すると、その他の変更も必要になります。Exchange 2010 のフェールオーバーでは、データベースがパッシブ コピーからアクティブ コピーに変換されると、データベース キャッシュがフラッシュします。Exchange 2013 では、ESE ログ記録のコードが書き直されて、パッシブからアクティブへの移行を通じてキャッシュが保持されるようになりました。ESE がキャッシュをフラッシュする必要がないので、フェールオーバーは高速になります。

もう 1 つの変更点は、バックグラウンド データベース メンテナンス (BDM) プロセスに対する変更です。BDM はコピーあたり毎秒約 1 ～ 2 MB を処理するようになりました。

これらの変更により、Exchange 2013 では Exchange 2010 と比較して IOPS が大幅に減少しました。

## 可用性管理

可用性管理は、組み込みのアクティブな監視と Exchange 2013 高可用性プラットフォームの統合です。可用性管理により、システムはサービスの正常性に基づいて、データベースをフェールオーバーするタイミングを判断できます。可用性管理は、Exchange 2013 のクライアント アクセスおよびメールボックス サーバーの役割上に展開される内部のインフラストラクチャです。可用性管理には、継続的に動作している 3 つの主要な非同期コンポーネントが含まれています。1 つ目のコンポーネントがプローブ エンジンです。このエンジンは、サーバーの測定値の抽出とデータの収集を担当します。それらの測定結果が 2 番目のコンポーネントであるモニターに渡ります。モニターには、収集したデータで正常と考えられるものに基づいて、システムによって使用されるビジネス ロジックのすべてが含まれています。モニターは、パターン認識エンジンと同様に、収集したすべての測定値についてさまざまなパターンを探し出し、対象が正常と判断されるかどうかの決定を下すことができます。最後に、回復操作を担当するレスポンダー エンジンがあります。正常でないものがある場合、最初の操作はそのコンポーネントの回復を試行することになります。回復操作は複数の段階で行われる可能性があります。たとえば、最初の試行でアプリケーション プールを再起動し、2 回目にサービスを再起動し、3 回目でサーバーを再起動します。その次の試行でサーバーをオフラインにしてそれ以上トラフィックを受信しないようにします。回復操作が成功しない場合、イベント ログ通知を介して問題が人間対応レベルに上げられます。

可用性管理は、次の 2 つのサービスの形で実装されています。

  - **Exchange Health Manager Service (MSExchangeHMHost.exe)**   これは、ワーカー プロセスの管理に使用されるコントローラー プロセスです。必要に応じて、ワーカー プロセスの構築、実行、開始、および停止に使用されます。また、ワーカー プロセスがクラッシュした場合の回復や、ワーカー プロセスが単一障害点になることを防ぐためにも使用されます。

  - **Exchange Health Manager Worker プロセス (MSExchangeHMWorker.exe)**   これは、ランタイムのタスクの実行を担当するワーカー プロセスです。

可用性管理においては、永続的なストレージを使用してその機能を実行します。

  - XML 構成ファイルを使用して、ワーカー プロセスのスタートアップ中に作業項目の定義を初期化します。

  - レジストリを使用して、ブックマークなどのランタイム データを格納します。

  - Crimson Channel イベント ログ インフラストラクチャを使用して、作業項目の結果を格納します。

可用性管理の詳細については、「[可用性管理](managed-availability-exchange-2013-help.md)」を参照してください。

## 管理ストア

以前のバージョンの Exchange Server (Exchange Server 4.0 から Exchange Server 2010 まで) すべては、メールボックス サーバーの役割で Information Store プロセス (Store.exe) の単一インスタンスを実行することをサポートしています。この単一 Store インスタンスは、サーバー上のすべてのデータベース (アクティブ、パッシブ、時間差、および回復) をホストします。以前の Exchange アーキテクチャでは、1 つのメールボックス サーバーでホストされているデータベース同士の分離は、あったとしてもごくわずかでした。単一のメールボックス データベースで問題が起こると、その他のすべてのデータベースに悪影響が及ぶ可能性があります。また、メールボックスの破損によるクラッシュによって、そのサーバーでホストされているデータベースのすべてのユーザーに対するサービスに影響が生じる可能性もあります。

旧バージョンの Exchange の単一 Store インスタンスに関する別の問題は、プロセッサのコア数が 8 から 12 なら Extensible Storage Engine (ESE) の拡張が良好であるものの、その数を超えるとプロセッサ間通信およびキャッシュ同期の問題によって拡張に悪影響が生じるというものです。これは、16 コアを上回るシステムを使用できる最近のさらに大規模なサーバーでは、ESE 用として 8 から 12 コアのアフィニティを管理し、Store プロセス以外 (たとえば、アシスタント、Search Foundation、可用性管理など) には他のコアを使用するという管理上の課題が生じることを意味します。その上、以前のアーキテクチャは Store プロセスのスケールアップを制限していました。

Exchange Server 自体が進化したように、Store.exe プロセスもここ数年で大幅に進化しました。しかし、単一プロセスであるため、結局はそのスケーラビリティは制限されており、これは単一障害点となります。これらの制限のために、Store.exe は Exchange 2013 では使用されなくなり、管理ストアに置き換えられました。

詳細については、「[管理ストア](managed-store-exchange-2013-help.md)」を参照してください。

## ディスクごとの複数のデータベース

Exchange 2013 におけるストレージの改善点は主として JBOD (Just a Bunch Of Disks) 構成用に設計されていますが、サポートされているすべてのストレージ構成で使用できます。そのような機能の 1 つは、同じボリューム上に複数のデータベースをホストする機能です。この機能は、大容量ディスクに対する Exchange の最適化です。これらの最適化により、容量、IOPS、再シード時間の観点から大容量ディスクの使用効率はより高まります。この最適化は JBOD ストレージ構成の実行に関連する課題に取り組むためのものです。

  - データベースのサイズは管理可能である必要があります。

  - 再シード操作は高速かつ信頼性が高くなければなりません。

  - ストレージの容量は増加しますが、IOPS は増加しません。

  - パッシブ データベース コピーをホストするディスクは IOPS の面で十分に活用されていません。

  - 時間差コピーには非対称のストレージ要件があります。

  - ディスクの空き容量が少ない状態から回復する場合、敏捷性は限られています。

ストレージ容量は引き続き増加する傾向にあり、間もなく 8 TB のドライブが利用できるようになります。8 TB のドライブを Exchange の最大データベース サイズのベスト プラクティス ガイドライン (2 TB) と組み合わせて使用すると、5 TB を超えるディスク容量が無駄になります。解決方法の 1 つは単純にデータベースを大きくすることですが、再シード時間が非常に長く、場合によっては、運用上、管理が不能になるほど再シード時間が長くなり、そのような大容量のデータをネットワーク経由でコピーする場合の信頼性が落ちるため、管理は困難になります。

また、Exchange 2010 モデルでは、パッシブ コピーを格納するディスクは IOPS の観点から十分に活用されていません。時間差パッシブ コピーの場合、アクティブ コピーおよび時間差でないパッシブ コピーの格納に使用されるディスクと比較して、IOPS の観点からディスクが十分に活用されていないだけでなく、そのサイズの観点から非対称でもあります。

継続的で長期にわたる実践から、Exchange 2013 が大容量ディスク (8 TB) を JBOD 構成でより効率的に使用できるように最適化されました。Exchange 2013 では、ディスクごとに複数のデータベースを配置して、同じサイズのディスクに時間差コピーを含む複数のデータベース コピーを格納できます。目標は、存在する複数のボリュームにユーザーを分散し、通常の運用中に、各 DAG メンバーが同じボリューム上にアクティブ、パッシブおよび時間差コピー (オプション) の組み合わせをホストする対称的なデザインを提供することです。

ボリュームごとに複数のデータベースを使用する構成の例を、以下に図示します。

**ボリュームごとに複数のデータベースを使用する構成**

![ディスクごとの複数のデータベース](images/Dn789066.c5e7d6c8-3e77-4f72-a873-5e9aaded9aa3(EXCHG.150).gif "ディスクごとの複数のデータベース")

上記の構成では対称的なデザインを提供しています。4 つのすべてのサーバーに同じ 4 つのデータベースが格納され、4 つのデータベースは、各サーバーで 1 つのディスクにホストされています。重要な点は、各データベースのコピーの数を、1 つのディスクがホストするデータベース コピーの数と等しくする必要があるということです。上記の例では、各データベースのコピーが 4 つあります。1 つのアクティブ コピー、2 つのパッシブ コピー、そして 1 つの時間差コピーです。各データベースには 4 つのコピーがあるため、適切な構成は各ボリュームに 4 つのコピーです。さらに、DAG および各サーバーにまたがってバランス調整されるように、アクティブ化の優先順位が構成されます。たとえば、アクティブ コピーのアクティブ化の優先順位の値は 1、1 番目のパッシブ コピーのアクティブ化の優先順位の値は 2、2 番目のパッシブ コピーのアクティブ化の優先順位の値は 3、時間差コピーのアクティブ化の優先順位の値は 4 になります。

ディスクごとに複数のデータベースを使用すると、存在するボリュームにユーザーをより適切に分散できるほか、再シードを必要とする障害 (ディスク障害など) の発生時に、データ保護の復元に要する時間が短くなるという利点があります。

データベースが大きくなるほど、データベースの再シードに要する時間は長くなります。たとえば、2TB のデータベースは再シードに 23 時間かかるのに対して、8TB のデータベースは再シードに最長で 93 時間 (ほぼ 4 日間) かかります。どちらのシードも約 20 MB/秒 で行われます。これは一般的に、非常に大きなデータベースは運用で許容可能な時間内にシードできないということを意味します。

1 つのディスクに 1 つのデータベース コピーを格納するというシナリオの場合、シード操作は事実上ソースに縛られています。なぜならディスクのシード処理は常に単一のソースから行われるためです。ボリュームを複数のデータベース コピーに分割し、パッシブ データベースのアクティブなコピーを別々の DAG メンバー上に置かれた指定されたボリュームに配置することで、システムはディスクを再シードする際にソースに縛られなくなります。障害が発生したディスクを交換すると、複数のソースから再シードされます。これにより、システムはこれらのデータベースに対するデータ保護を、非常に短い時間で再シードして復元できます。

ボリュームごとに複数のデータベースを使用する場合、次のベスト プラクティスと要件に従うことをお勧めします。

  - 物理ディスクごとに 1 つの論理ディスクのパーティションを使用する必要があります。ディスク上に複数のパーティションを作成しないでください。各データベース コピーと付随するファイル (トランザクション ログやコンテンツ インデックスなど) は、1 つのパーティションの一意のディレクトリにホストされている必要があります。

  - 1 つのボリュームに構成されたデータベース コピーの数は、各データベースのコピーの数と一致する必要があります。たとえば、データベースのコピーが 4 つある場合、ボリュームごとに 4 つのデータベース コピーを使用する必要があります。

  - データベース コピーは同じ場所にある必要があります (たとえば、すべてのデータベース コピーが各サーバーの同じディスクを共有する必要があります)。

  - DAG にまたがるアクティブ化の優先順位をバランス調整し、指定されたディスク上にある各データベース コピーのアクティブ化優先順位の値が一意になるようにする必要があります。

## AutoReseed

自動再シード、または AutoReseed は、ディスクの障害、データベース破損の発生、またはデータベース コピーの再シードが必要なその他の問題に対応するために通常は管理者によって行われる操作の代わりとなる機能です。AutoReseed は、ディスクの障害発生後にシステムでプロビジョニング済みの予備のディスクを使用して、自動的にデータベースの冗長性を復元するように設計されています。

詳細については、「[AutoReseed](autoreseed-exchange-2013-help.md)」を参照してください。AutoReseed の構成手順の詳細については、「[データベース可用性グループの AutoReseed の構成](configure-autoreseed-for-a-database-availability-group-exchange-2013-help.md)」を参照してください。

## ストレージ障害からの自動回復

ストレージ障害からの自動回復の機能は Exchange 2010 で導入された新技術を継続したもので、復元力または冗長性に影響する障害からシステムを回復できます。Exchange 2013 には、Exchange 2010 のバグチェック動作に加えて、実行時間の長い入出力、Microsoft Exchange レプリケーション サービス (MSExchangeRepl.exe) によるメモリの過剰な消費、さらにスレッドをスケジュールできないような重大なケースに対する回復動作が含まれています。

JBOD 環境においても、クラッシュやハングといったストレージ アレイ コントローラーの問題が発生する場合があります。Exchange 2010 には、ハング I/O の検出や拡張された復元を提供する回復機能が組み込まれました。次の表にこれらの機能を表示します。


<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>名前</th>
<th>チェック</th>
<th>操作</th>
<th>しきい値</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>ESE データベースのハング IO 検出</p></td>
<td><p>ESE は突出した I/O をチェックします</p></td>
<td><p>クリムゾン チャネルで障害項目を生成してサーバーを再起動します</p></td>
<td><p>240 秒</p></td>
</tr>
<tr class="even">
<td><p>障害項目チャネルのハートビート</p></td>
<td><p>障害項目がクリムゾン チャネルに対して書き込みと読み取りができることを確認します</p></td>
<td><p>レプリケーション サービスはクリムゾン チャネルにハートビートを送信して障害のあるサーバーを再起動します</p></td>
<td><p>30 秒</p></td>
</tr>
<tr class="odd">
<td><p>システム ディスクのハートビート</p></td>
<td><p>サーバーのシステム ディスクの状態を確認します</p></td>
<td><p>システム ディスクに対して非バッファー I/O を定期的に送信し、ハートビートがタイムアウトするとサーバーを再起動します</p></td>
<td><p>120 秒</p></td>
</tr>
</tbody>
</table>


Exchange 2013 では、その他の重大な状況への新しい対処方法を含めることで、サーバーおよびストレージの復元機能を拡張しています。次の表で、これらの状況と動作について説明します。


<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>名前</th>
<th>チェック</th>
<th>操作</th>
<th>しきい値</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>問題があるシステムの状態</p></td>
<td><p>スレッド (非管理スレッドを含む) をスケジュールできない</p></td>
<td><p>サーバーを再起動する</p></td>
<td><p>302 秒</p></td>
</tr>
<tr class="even">
<td><p>実行時間の長い I/O</p></td>
<td><p>I/O 操作の遅延の測定</p></td>
<td><p>サーバーを再起動する</p></td>
<td><p>41 秒</p></td>
</tr>
<tr class="odd">
<td><p>レプリケーション サービスのメモリ使用量</p></td>
<td><p>MSExchangeRepl.exe のワーキング セットの測定</p></td>
<td><ol>
<li><p>クリムゾン チャネルにサービス終了要求と共にイベント 4395 を記録する</p></li>
<li><p>MSExchangeRepl.exe の終了を開始する</p></li>
<li><p>サービスの終了が失敗した場合は、サーバーを再起動する</p></li>
</ol></td>
<td><p>4 ギガバイト (GB)</p></td>
</tr>
<tr class="even">
<td><p>システム イベント 129 (バス リセット)</p></td>
<td><p>システム イベント ログでイベント 129 をチェックする</p></td>
<td><p>サーバーを再起動する</p></td>
<td><p>イベントが発生した場合</p></td>
</tr>
<tr class="odd">
<td><p>クラスター データベースのハングアップ</p></td>
<td><p>グローバル更新マネージャーの更新プログラムがブロックされた場合</p></td>
<td><p>サーバーを再起動する</p></td>
<td><p>イベントが発生した場合</p></td>
</tr>
</tbody>
</table>


## 時間差コピーの機能強化

時間差コピーの機能強化には、セーフティ ネットとの統合および特定のシナリオにおけるログ ファイルの自動再生が含まれます。セーフティ ネットはトランスポートの機能で、Exchange 2010 のトランスポート収集と呼ばれた機能に代わるものです。セーフティ ネットは、メールボックス サーバー上のトランスポート サービスに関連付けられた配信キューという点においてトランスポート収集に似ています。このキューは、メールボックス サーバー上のアクティブなメールボックス データベースに正常に配信されたメッセージのコピーを格納します。メールボックス サーバー上のそれぞれのアクティブなメールボックス データベースには、配信されたメッセージのコピーを格納する自身のキューがあります。セーフティ ネットが、正常に配信されたメッセージのコピーを期限切れで自動的に削除するまで保存する期間を指定できます。

セーフティ ネットは、DAG 環境におけるシャドウ冗長性から一部の責任を引き継ぎます。配信されたメッセージが、DAG の他のメールボックス サーバーにあるメールボックス データベースのパッシブ コピーにレプリケートされるのを待機している間は、DAG 環境では、シャドウ冗長がシャドウ キューの配信されたメッセージの別のコピーを保持する必要はありません。配信されたメッセージのコピーは既にセーフティ ネットに保存されていますので、必要に応じてシャドウ冗長はメッセージをセーフティ ネットから再配信できます。

セーフティ ネットの導入によって、時間差データベース コピーのアクティブ化は非常に容易になりました。たとえば、2 日間の時間差がある時間差コピーがあると仮定します。その場合、セーフティ ネットを 2 日間で構成します。時間差コピーを使用する必要がある状況になると、それに対するレプリケーションを一時停止して、それを 2 回コピーします (データベースの時間差の性質を保持して、必要になった場合のために追加のコピーを作成するためです)。次に、コピーを作成して必要な範囲以外のログ ファイルをすべて破棄します。コピーをマウントすると、直近 2 日間のメールを再配信するようセーフティ ネットに対して自動要求をトリガーします。セーフティ ネットでは、破損のポイントが導入された時点以降、これ以上の破損は起こりません。直近 2 日間のメールを取り戻すことはできますが、当然、損失の大きいフェールオーバーで普通に失われたデータを除きます。

時間差コピーは、自動ログ再生を起動してログ ファイルを再生することで、特定のシナリオで自身を管理できるようになりました。

  - 低ディスク容量のしきい値に達した場合

  - 時間差コピーに物理的な破損があり、ページ パッチが必要な場合

  - 24 時間を超える期間、正常なコピー (アクティブまたはパッシブのみ - 時間差データベース コピーは含まれません) が 3 つ未満の場合

Exchange 2010 では、時間差コピーにはページ パッチは利用できませんでした。Exchange 2013 では、自動ログ再生機能によって時間差コピーのページ パッチが利用できます。時間差コピーに対してページ パッチが必要であることが検知されると、ログが自動的に時間差コピーに対して再生され、ページ パッチが実行されます。時間差コピーでは、低ディスク容量のしきい値に達した場合、および時間差コピーが特定の時間帯において唯一の利用可能なコピーであると検知された場合にも、この自動再生機能が呼び出されます。

遅延コピーのログ再生動作は既定では無効で、有効にするには次のコマンドを実行します。

```powershell
Set-DatabaseAvailabilityGroup <DAGName> -ReplayLagManagerEnabled $true
```

有効にすると、コピーが 3 つ未満の場合にログ再生が発生します。次の DWORD レジストリ値を変更することで、既定値の 3 を変更できます。

**HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\Replay\\Parameters\\ReplayLagManagerNumAvailableCopies**

低ディスク容量のしきい値に対するログ再生を有効にするには、次のレジストリ エントリを構成する必要があります。

**HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\Replay\\Parameters\\ReplayLagLowSpacePlaydownThresholdInMB**

これらのレジストリ設定を構成した後、Microsoft Exchange DAG 管理サービスを再開して、変更を有効にします。

例として、特定のデータベースにコピーが 4 つ (3 つの高可用コピーと 1 つの時間差コピー) があり、*ReplayLagManagerNumAvailableCopies* の既定の設定が使用されている環境を考えます。何らかの理由 (一時停止など) により時間差でないコピーのサービスが停止していると、自動的に時間差コピーが 24 時間内のログ ファイルを再生します。

## 単一コピーの警告の機能強化

サーバーが確実に動作していて、メールボックス データベース コピーが正常であることを確認するのは、Exchange 2013 メッセージングの毎日の運用における主な目的です。ハードウェア、Windows オペレーティング システム、および Exchange サービスをアクティブに監視する必要があります。しかし、Exchange 2013 メールボックスの復元環境で実行する場合、DAG およびメールボックス データベース コピーの正常性と状態を監視することが重要です。データ冗長性のリスク管理を行い、レプリケートされたデータベースがただ 1 つのコピーになった期間を監視することは特に重要です。これは、RAID (Redundant Array of Independent Disks) を使用する代わりに JBOD 構成を展開している環境において特に重要です。RAID 環境では、単一のディスクの障害がアクティブ メールボックス データベースのコピーに影響を及ぼすことはありません。ただし、JBOD 環境では単一ディスクの障害によってデータベースのフェールオーバーがトリガーされます。

Exchange 2010 では、CheckDatabaseRedundancy.ps1 というスクリプトが導入されました。そのスクリプトの目的は、その名が示す通り、レプリケートされたメールボックス データベースの冗長性を監視することです。これは、現在少なくとも 2 つの構成された正常なコピーが存在することを確認することで実行されます。また、レプリケートされたデータベースの正常なコピーが 1 つしか存在しない場合にはイベント ログの生成を通して管理者にアラートを出すこともこのスクリプトの目的です。この場合、アクティブ コピーとパッシブ コピーの両方が、冗長性を判断するときに考慮されます。

以下は、コピーが 1 つしかない状態の例の一部です。

  - アクティブ コピーからパッシブ コピーへのレプリケートの失敗。

  - すべてのパッシブ コピーの障害。これには、コピーがログのコピーまたは再生に遅れている正常な状態に加え、FailedAndSuspended および Failed の状態が含まれます。時間差コピーは、時間差期間に対するログの再生が 10 分以内の場合には遅れている状態とは考えられません。

  - アクティブ コピーの現在のログ世代を正確に把握するシステムの障害。

管理者にとって、データベースの正常なコピーが 1 つだけになっている状態を把握することは最優先なため、CheckDatabaseRedundancy.ps1 スクリプトは、可用性管理の DataProtection 正常性セットに含まれる、統合されたネイティブな機能に置き換えられました。

ネイティブの機能は依然としてイベント ログ通知を通して管理者に警告を出します。Exchange 2013 は、Exchange 2013 の警告を Exchange 2010 と区別するために、次のイベント ID を使用します。

  - イベント 4138 (赤色の警告)

  - イベント 4139 (緑色の警告)

Exchange 2013 では、ネイティブの機能が強化され、同一のサーバー上の複数のデータベースが 1 つのコピーの状態になったときに発せられる不要な警告が少なくなっています。Exchange 2010 では、1 つのコピーの警告はデータベースごとのレベルで生成されていました。その結果、サーバー全体にわたる問題が発生して複数のデータベースや複数のデータベース コピーに影響が及ぶと、大量の警告が発生していました。コントローラーの問題、メモリの問題などのいくつかの障害はサーバー全体にわたるため、ある程度高い確率で、そのような大量の警告が 1 つのサーバー インシデントについて発生していました。Exchange 2013 では、警告はサーバー単位で生成されるようになりました。停止がサーバー全体に影響し、データの冗長性が複数のデータベース コピーに対するリスクとなった場合、サーバーごとに 1 つの警告が生成されるようになりました。

## DAG ネットワークの自動構成

DAG ネットワークは、レプリケーション トラフィックまたは MAPI トラフィックのいずれかに使用する 1 つまたは複数のサブネットの集合です。DAG ごとに、最大 1 つの MAPI ネットワークと 0 または 1 つ以上のレプリケーション ネットワークが含まれます。Exchange 2010 では、最初の DAG ネットワーク (DAGNetwork01 や DAGNetwork02 など) は、クラスター サービスによって列挙されるサブネットに基づいて、システムによって作成されていました。複数のネットワークが使用されている環境で、指定されたネットワーク (MAPI ネットワークなど) のインターフェイスが同じサブネット上にあった場合、管理者が実行する必要がある追加の構成はほとんどありませんでした。ただし、指定されたネットワークのインターフェイスが複数のサブネット上にある環境では、管理者は DAG のネットワークの折りたたみと呼ばれるタスクを実行する必要がありました。

Exchange 2013 では、DAG ネットワークの折りたたみは不要になりました。Exchange 2013 では、MAPI とレプリケーション ネットワークを区別するために同じ検出メカニズムを使用していますが、必要に応じて DAG ネットワークの折りたたみを自動的に行うようになりました。

さらに、DAG ネットワークが既定でシステムによって自動的に管理されるようになりました。Exchange 管理センター (EAC) を使用して DAG ネットワークのプロパティを表示するためには、EAC を使用して DAG のプロパティを変更するか、**Set-DatabaseAvailabilityGroup** コマンドレットを使用して *ManualDagNetworkConfiguration* パラメーターを `True` に設定して、DAG を手動によるネットワーク制御用に構成する必要があります。

## 最適なコピー選択に対する変更

最適なコピー選択 (BCS) は、個別のデータベースの最適なコピーを見つけてアクティブにするための内部のアルゴリズム処理で、アクティブにする可能性のあるコピーとその正常性および状態の一覧が渡されます。アクティブ マネージャーは、既存のアクティブなデータベース コピーに障害が発生した場合または管理者がターゲットを指定せずに切り替えを実行した場合に、新しいアクティブなデータベースとなる最適で利用可能な (ブロックされていない) コピーを選択します。Exchange 2010 では、BCS プロセスが各データベース コピーの複数の側面を評価して、アクティブ化する最良のコピーを判別しました。これらには次のようなものがあります。

  - コピー キューの長さ

  - 再生キューの長さ

  - データベースの状態

  - コンテンツ インデックスの状態

Exchange 2013 では、アクティブ マネージャーは同じ BCS の確認および段階を実行してレプリケーションの正常性を判断しますが、正常性状態の降順の制約の使用も含めるようになりました。これらの変更の結果、BCS は最適なコピーおよびサーバーの選択 (BCSS) と呼ばれるようになりました。

BCSS には、Exchange 2013 の可用性管理監視コンポーネントの一部として組み込まれている、いくつかの新しい正常性の確認が含まれています。新しくアクティブ マネージャーによって追加で実行されるチェックが 4 つあります (実行される順に以下に示します)。

1.  **すべて正常 (All Healthy)**   影響を受ける (すべての監視コンポーネントを含む) データベースのコピーをホストするサーバーが正常な状態にあることをチェックします。

2.  **最大で標準の正常性 (Up to Normal Healthy)**   影響を受け (すべての監視コンポーネントを含み) 優先度が標準であるデータベースのコピーをホストするサーバーが正常な状態にあることをチェックします。

3.  **すべてソースより良好 (All Better than Source)**   影響を受ける (監視コンポーネントを含む) データベースのコピーをホストするサーバーが、影響を受けるコピーをホストしている現在のサーバーよりも良い状態にあることをチェックします。

4.  **ソースと同等 (Same as Source)**   影響を受ける (監視コンポーネントを含む) データベースのコピーをホストするサーバーが、影響を受けるコピーをホストしている現在のサーバーと同等の状態にあることをチェックします。

可用性管理の監視コンポーネント (フェールオーバー レスポンダー経由など) によってトリガーされたフェールオーバーの結果、BCSS が起動されると、ターゲット サーバーのコンポーネントの正常性は、フェールオーバーが発生したサーバー以上でなければならないという追加の必須の制約が強制されます。たとえば、Microsoft Office Outlook Web App の障害によりフェールオーバー レスポンダーを介して可用性管理フェールオーバーがトリガーされると、BCSS は Outlook Web App が正常で、影響を受けたデータベースのコピーをホストしているサーバーを選択しなければなりません。

## DAG Management サービス

Exchange 2013 の RTM (Release To Manufacturing) 版の累積更新プログラム 2 (CU2) には、DAG のメンバーであるメールボックス サーバーの新しいサービスが含まれています。このサービスは、Microsoft Exchange DAG Management サービス (MSExchangeDAGMgmt) といいます。この新しいサービスには、以前は Microsoft Exchange Replication サービス (MSExchangeRepl) の中で実行されていた DAG 内部監視機能が含まれています。

## クラスター管理アクセス ポイントなしの DAG

Windows Server 2008 R2 または Windows Server 2012 を実行しているすべての DAG には、MAPI ネットワークに含まれるサブネットごとに最低 1 つの IP アドレスが必要です。DAG に割り当てられた IP アドレスは、クラスター名を使用してクラスターへの名前解決および接続 (具体的には、現在クラスター コア リソース グループを所有するクラスター メンバーへの接続) を有効にするために、クラスターの管理アクセス ポイント (クラスター ネットワーク名とも呼ばれます) が設定された DAG のクラスターにより使用されます。Windows Server 2012 R2 では、管理アクセス ポイントを使用せずにフェールオーバー クラスターを作成することができます。管理アクセス ポイントを使用しない Windows フェールオーバー クラスターには、次のような特性があります。

  - クラスターには IP アドレスが割り当てられないため、クラスター コア リソース グループに IP アドレス リソースは含まれません。

  - クラスターにはネットワーク名が割り当てられないため、クラスター コア リソース グループにネットワーク名リソースは含まれません。

  - クラスターの名前は DNS に登録されないため、ネットワーク上でクラスターの名前を解決できません。

  - Active Directory にクラスター名オブジェクト (CNO) は作成されません。

  - Windows フェールオーバー クラスターは、フェールオーバー クラスター管理ツールを使用して管理できません。Windows PowerShell を使用して管理し、PowerShell コマンドレットを個々のクラスターのメンバーに対して実行する必要があります。

Windows Server 2012 R2 以降で実行する場合、Exchange 2013 の Service Pack 1 (SP1) 以降を適用することで、クラスター管理アクセス ポイントなしで DAG を作成できます。Exchange 管理センターまたはシェルを使用して、クラスター管理アクセス ポイントなしで DAG を作成できます。詳細については、「[Creating DAGs](managing-database-availability-groups-exchange-2013-help.md)」および「[データベース可用性グループを作成する](create-a-database-availability-group-exchange-2013-help.md)」を参照してください。

