---
title: 'メールボックス データベースのコピーの管理: Exchange 2013 Help'
TOCTitle: メールボックス データベースのコピーの管理
ms:assetid: 28cedf1d-365a-4e36-b2ba-6bf81af8684f
ms:mtpsurl: https://technet.microsoft.com/ja-jp/library/Dd335158(v=EXCHG.150)
ms:contentKeyID: 48269288
ms.date: 04/24/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# メールボックス データベースのコピーの管理

 

_**適用先:** Exchange Server 2013_

_**トピックの最終更新日:** 2016-08-26_

データベース可用性グループ (DAG) を作成して構成し、メールボックス サーバーのメンバーをそのグループに事前に設定しておくと、Exchange 管理センター (EAC) または Exchange 管理シェルを使用して、メールボックス データベース コピーを柔軟かつ詳細に追加できます。

## データベース コピーの管理

データベースの複数のコピーを作成した後、EAC またはシェルを使用して、各コピーの正常性と状態を監視して、データベース コピーに関連するその他の管理タスクを実行できます。実行の必要な可能性がある一部の管理タスクには、データベース コピーの中断と再開、データベース コピーのシード、データベース コピーの監視、データベース コピー設定の構成、およびデータベース コピーの削除が含まれます。

## データベース コピーの中断と再開

計画された保守の実行などのさまざまな理由から、データベース コピーの連続レプリケーション活動の中断と再開が必要な場合があります。さらに、シードなどの一部の管理タスクでは、先にデータベース コピーを中断する必要があります。データベースのパス、またはデータベースのログ ファイルを変更する場合には、すべてのレプリケーション活動を中断することを推奨します。EAC を使用するか、シェルで **Suspend-MailboxDatabaseCopy** コマンドレットおよび **Resume-MailboxDatabaseCopy** コマンドレットを実行することで、データベース コピー活動を中断して再開できます。データベース コピーの連続レプリケーション活動の中断または再開に関する詳細な手順については、「[メールボックス データベース コピーを中断または再開する](suspend-or-resume-a-mailbox-database-copy-exchange-2013-help.md)」を参照してください。

## データベース コピーのシード

*シード* (*更新*) とは、空のデータベースや運用データベースのコピーに関わらず、同じ DAG にある別のメールボックス サーバー上のコピー先に、アクティブ データベースとしてデータベースをコピーする処理のことです。これは、そのサーバーによって維持されるコピーのベースライン データベースとなります。

状況に応じて、シードを自動プロセスにしたり、管理者が開始する手動プロセスにしたりすることができます。データベース コピーが追加されると、シード先サーバーとそのストレージが適切に構成されていれば、コピーは自動的にシードされます。データベース コピーを手動でシードして、コピー作成時に自動シードが行われないようにするには、[Add-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd298105\(v=exchg.150\)) コマンドレットの実行時に *SeedingPostponed* パラメーターを使用します。

最初のシードが行われた後、データベース コピーを再シードする必要はほとんどありません。再シードが必要な場合や、システムによるコピーの自動シードではなく、データベース コピーを手動でシードする場合は、EAC のメールボックス データベース コピーの更新ウィザードや、シェルの [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットを使用して、これらのタスクを実行できます。データベース コピーをシードする前に、先にメールボックス データ コピーを中断する必要があります。データベース コピーをシードする方法の詳細については、「[メールボックス データベース コピーの更新](update-a-mailbox-database-copy-exchange-2013-help.md)」を参照してください。

手動シード操作が完了すると、シードされたメールボックス データ ベースのコピーは自動的に再開します。複製を自動的に再開しない場合、[Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットを実行するときに *ManualResume* パラメーターを使用します。

## シード対象の選択

シード操作を実行するとき、メールボックス データベース コピー、メールボックス データベース コピーのコンテンツ インデックス カタログ、またはデータベース コピーとコンテンツ インデックス カタログ コピーの両方をシードできます。

メールボックス データベース コピーの更新ウィザードと [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットの既定の動作では、メールボックス データベース コピーとコンテンツ インデックス カタログ コピーの両方をシードします。コンテンツ インデックス カタログをシードしないでメールボックス データベース コピーのみをシードするには、[Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットの実行時に、*DatabaseOnly* パラメーターを使用します。コンテンツ インデックス カタログ コピーのみをシードするには、[Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットの実行時に、*CatalogOnly* パラメーターを使用します。

## シード元の選択

あらゆる正常なデータベース コピーを、そのデータベースの追加コピー用のシード元として使用できます。これは、DAG が複数の物理的な場所にまたがる場合などに特に便利です。例として、2 メンバー (MBX1 と MBX2) がオレゴン州のポートランドに配置され、2 メンバー (MBX3 と MBX4) がニューヨーク州のニューヨークに配置されている 4 メンバーの DAG 展開を考えます。メールボックス データベース DB1 が MBX1 上でアクティブであり、DB1 のパッシブ コピーが MBX2 と MBX3 にあるとします。DB1 のコピーを MBX4 に追加する場合、MBX3 上でそのコピーをシード元として使用することができます。こうすることで、ポートランドとニューヨーク間の広域ネットワーク (WAN) リンクを介してシードすることを回避できます。

新しいデータベース コピーを追加するときに、シード用のシード元として特定のコピーを使用するには、以下の操作を実行します。

  - データベース コピーを追加するのに [Add-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd298105\(v=exchg.150\)) コマンドレットを実行するとき、*SeedingPostponed* パラメーターを使用します。*SeedingPostponed* パラメーターを使用しないと、データベース コピーはデータベースのアクティブ コピーがシード元として使用され明示的にシードされます。

  - EAC でメールボックス データベース コピーの更新ウィザードの一部として使用するシード元サーバーを指定したり、[Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットを実行する際に *SourceServer* パラメーターを使用してシード用のシード元サーバーを指定したりすることができます。上記の例では、MBX3 をシード元サーバーとして指定します。*SourceServer* パラメーターを使用しないと、データベース コピーはデータベースのアクティブ コピーから明示的にシードされます。

## シードとネットワーク

メールボックス データベース コピーをシードするための特定シード元サーバーを選択することに加え、シェルを使用して、使用する DAG ネットワークも指定することができ、オプションでシード操作中の DAG ネットワークの圧縮および暗号化設定を上書きすることができます。


> [!NOTE]
> コンテキスト インデックス カタログのシード処理は、MAPI ネットワーク経由でのみ可能です。これは、Update-MailboxDatabaseCopy コマンドレットに <CODE>-Network</CODE> パラメーターを使用する場合にも当てはまります。



シードに使用するネットワークを指定するには、[Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットを実行するときに *Network* パラメーターを使用して、使用する DAG ネットワークを指定します。*Network* パラメーターを使用しないと、シード操作に使用するネットワークを選択するための既定の動作が用いられます。

  - シード元サーバーとシード先サーバーが同一サブネット上にあり、そのサブネットを含むレプリケーション ネットワークが構成済みの場合は、レプリケーション ネットワークが使用されます。

  - シード元サーバーとシード先サーバーが異なるサブネットに存在する場合、それらのサブネットを含むレプリケーション ネットワークが構成されていたとしても、シードにはクライアント (MAPI) ネットワークが使用されます。

  - シード元サーバーとシード先サーバーが異なるデータセンターに存在する場合、シードにはクライアント (MAPI) ネットワークが使用されます。

DAG レベルで暗号化と圧縮に関して DAG ネットワークが構成されます。既定の設定では、異なるサブネット上での通信にのみ、暗号化と圧縮が使用されます。シード元とシード先が異なるサブネット上に存在し、DAG に *NetworkCompression* および *NetworkEncryption* の既定値が構成されている場合、[Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットを実行中にそれぞれ *NetworkCompressionOverride* と *NetworkEncryptionOverride* パラメーターを使用することで、これらの値を上書きできます。

## シード処理

[Add-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd298105\(v=exchg.150\)) または [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd335201\(v=exchg.150\)) コマンドレットを使用してシード処理を開始する場合、以下のタスクが実行されます。

1.  Active Directory からデータベースのプロパティが読み取られ、指定されたデータベースとサーバーが検証され、シード元サーバーとシード先サーバーが Exchange 2013 を実行していること、両者とも同じ DAG のメンバーであること、および指定されたデータベースが回復データベースではないことが確認されます。データベース ファイルのパスも読み取られます。

2.  シード先サーバーの Microsoft Exchange レプリケーション サーバーから、再シード チェックの準備が行われます。

3.  シード先サーバーの Microsoft Exchange レプリケーション サービスが、ステップ 1 で Active Directory チェックによって読み取られたファイル ディレクトリにデータベースとトランザクション ログ ファイルが存在することをチェックします。

4.  Microsoft Exchange レプリケーション サービスが、コマンドレットが実行された管理インターフェイスに、シード先サーバーからの状態情報を返します。

5.  すべての事前チェックに合格すると、続行する前に操作を確認するように求められます。操作を確認すると、処理が続行します。事前チェック中にエラーが発生すると、エラーが報告され、操作は異常終了します。

6.  シード操作は、シード先サーバーの Microsoft Exchange レプリケーション サービスから開始します。

7.  Microsoft Exchange レプリケーション サービスは、アクティブ データベース コピーのデータベース レプリケーションを中断します。

8.  データベースの状態情報が Microsoft Exchange レプリケーション サービスによって更新され、シードの状態が反映されます。

9.  シード先サーバーにシード先データベースとログ ファイルのディレクトリが存在しない場合、作成されます。

10. シード先サーバーの Microsoft Exchange レプリケーション サーバーから、シード元サーバーの Microsoft Exchange レプリケーション サービスに、TCP を使用してデータベースをシードする要求が渡されます。この要求とその後のデータベースをシードするための通信が、レプリケーション ネットワークとして構成された DAG ネットワーク上で行われます。

11. シード先 Microsoft Exchange レプリケーション サービスが、Microsoft Exchange インフォメーション ストア サービス インターフェイス経由で、Extensible Storage Engine (ESE) ストリーミング バックアップを開始します。

12. Microsoft Exchange インフォメーション ストア サービスが、Microsoft Exchange レプリケーション サービスにデータベース データをストリームします。

13. シード元サーバーの Microsoft Exchange レプリケーション サービスから、シード先サーバーの Microsoft Exchange レプリケーション サービスまで、データベース データが移動します。

14. シード先サーバーの Microsoft Exchange レプリケーション サービスが、*temp-seeding* というメイン データベース ディレクトリにある一時ディレクトリにデータベース コピーを書き込みます。

15. データベースの最後に到達すると、シード元サーバー上のストリーミング バックアップ操作が終了します。

16. シード先サーバーの書き込み操作が完了し、temp-seeding ディレクトリから最終的な場所までデータベースが移動します。temp-seeding ディレクトリが削除されます。

17. シード先サーバー上で Microsoft Exchange レプリケーション サービスが Microsoft Exchange 検索サービスに要求を転送し、データベース コピーのコンテンツ インデックス カタログをマウントします (存在する場合)。データベース コピーの以前のインスタンスの最新ではないカタログ ファイルが存在する場合、マウント操作は失敗し、結果としてシード元サーバーからのカタログの複製が必要になります。同様に、シード先サーバーのデータベース コピーの新しいインスタンスにカタログが存在しない場合、カタログのコピーが必要になります。Microsoft Exchange レプリケーション サービスが Microsoft Exchange 検索サービスを検出し、シード元から新しいカタログをコピーしている間、データベース コピーのインデックス処理を中断します。

18. シード先サーバーの Microsoft Exchange レプリケーション サービスがシード元サーバーの Microsoft Exchange レプリケーション サービスに、シードカタログ要求を送信します。

19. シード元サーバー上で Microsoft Exchange レプリケーション サービスが Microsoft Exchange 検索サービスからのディレクトリ情報を要求し、インデックス処理の中断を要求します。

20. シード元サーバーの Microsoft Exchange 検索サービスが、Microsoft Exchange レプリケーション サービスに検索カタログ ディレクトリ情報を返します。

21. シード元サーバーの Microsoft Exchange レプリケーション サービスが、ディレクトリからのカタログ ファイルを読み取ります。

22. シード元サーバーの Microsoft Exchange レプリケーション サービスが、レプリケーション ネットワークにわたる接続を使用して、シード先サーバーの Microsoft Exchange レプリケーション サービスにカタログ データを移動します。読み取りが完了すると、Microsoft Exchange レプリケーション サービスが Microsoft Exchange 検索サービスにシード元データベースのインデックス処理を再開する要求を送信します。

23. シード先サーバーのディレクトリに何らかの既存ファイルが存在する場合、シード先サーバーの Microsoft Exchange レプリケーション サービスがそれらのファイルを削除します。

24. シード先サーバーの Microsoft Exchange レプリケーションサービスが、データが完全に転送されるまで *CiSeed.Temp* という一時ディレクトリにカタログ データを書き込みます。

25. Microsoft Exchange レプリケーションサービスが、最終的な場所にまで完全なカタログ データを移動します。

26. シード先サーバーの Microsoft Exchange レプリケーションサービスが、シード先データベースの検索インデックス処理を再開します。

27. シード先サーバーの Microsoft Exchange レプリケーションサービスが完了状態を返します。

28. オペレーションの最終結果が、コマンドレットの呼び出し元である管理インターフェイスに返されます。

## データベース コピーの構成

データベース コピーが作成されると、必要なときにデータベース コピーの構成設定を表示して確認できるようになります。EAC で、データベース コピーの <strong>プロパティ</strong> ページを確認することで、一部の構成情報を表示できます。シェルで [Get-MailboxDatabase](https://technet.microsoft.com/ja-jp/library/bb124924\(v=exchg.150\)) および [Set-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd298104\(v=exchg.150\)) コマンドレットを使用しても、再生の時間差、切り捨ての時間差、およびアクティベーションの優先順位などのデータベース コピー設定を表示して構成できます。データベース コピー設定の表示と構成に関する詳細な手順については、「[メールボックス データベースのコピーのプロパティを構成する](configure-mailbox-database-copy-properties-exchange-2013-help.md)」を参照してください。

## 再生の時間差オプションと切り捨ての時間差オプションの使用

メールボックス データベース コピーは、*再生の時間差*と*切り捨ての時間差* (両者とも分単位で構成する) の使用をサポートします。再生の時間差を設定することで、データベース コピーを特定の時点にまで戻すことができるようになります。切り捨ての時間差を設定することで、パッシブ データベース コピーのログを使用して、アクティブ データベース コピーのログ ファイルの損失を復元できるようになります。これらの機能の両方ともログ ファイルが一時的に増加するため、どちらの機能を使用するにしても、ストレージの設計に影響します。

## 再生の時間差

再生の時間差とは、メールボックス データベース コピーのプロパティであり、データベース コピーのログ再生を遅らせる時間を分で指定します。再生の時間差タイマーは、ログ ファイルがパッシブ コピーに複製され、検査に合格した時点から開始します。データベース コピーへのログの再生を遅らせることにより、データベースを過去の特定時点にまで復元することができるようになります。0 よりも大きい再生ラグ タイムで構成されたメールボックス データベース コピーは、*遅延メールボックス データベース コピー*、または単に*時間差コピー*と呼ばれます。

Exchange 2013 でデータベース コピーと訴訟ホールド機能を用いる方針により、通常はデータの損失をもたらすことになるさまざまな障害に対する保護が得られます。ただしこれらの機能では、まれに発生し、データ損失の原因となる論理的な破損の場合、データ損失に対する保護は得られません。時間差コピーは、論理的な破損の場合のデータの損失を防ぐことを目的としています。一般的に、論理的な破損には以下の 2 種類が存在します。

  - **データベースの論理的破損**   データベース ページのチェックサムが一致するものの、ページ上のデータが論理的に間違っています。これは、ESE がデータベース ページに書き込もうとして、オペレーティング システムが成功メッセージを返したものの、データがディスクに書き込まれていないか、間違った場所に書き込まれた場合に発生します。これは、*ロスト フラッシュ*と呼ばれます。ロスト フラッシュによりデータを失わないようにするため、ESE により、ページ パッチ機能 (単一ページの復元) と一緒に、ロスト フラッシュ検出機構がデータベースに組み込まれています。

  - **ストアの論理的破損**   ユーザーが予期しない仕方で、データが追加、削除、または操作されます。これらの場合は通常、サード パーティ製のアプリケーションによって引き起こされます。これは通常、ユーザーの観点から見た意味での破損にすぎません。Exchange ストアは、論理的破損を引き起こすトランザクションを一連の有効な MAPI 操作として見なします。Exchange 2013 の訴訟ホールド機能により、ストアの論理的破損からの保護が得られます (この機能は、ユーザーやアプリケーションがコンテンツを永続的に削除することを防ぐためです)。ただし、ユーザー メールボックスの破損の程度が激しい場合、データベースを破損前の時点にまで復元してから、ユーザー メールボックスをエクスポートして破損していないデータを取得する方が容易なシナリオも考えられます。

データベース コピー、情報保留ポリシー、および ESE 単一ページ復元を組み合わせることで、まれに発生する壊滅的なストアの論理的破損以外の破損に対処できます。再生に時間差があるデータベース コピー (時間差コピー) を使用するかどうかは、どのサードパーティ製アプリケーションを使用するか、および組織でストアの論理的破損がこれまでにあったかどうかによって異なります。

時間差コピーは、ユーザーが自動ログ再生を起動して特定のシナリオでログ ファイルを再生するときに、コピー自体の管理を Exchange 2013 内で行うことができます。

  - 低ディスク容量のしきい値に達した場合

  - 時間差コピーに物理的な破損があり、ページ パッチが必要な場合

  - 24 時間を超える期間、正常なコピー (アクティブまたはパッシブのみ - 時間差データベース コピーは含まれません) が 3 つ未満の場合

自動ログ再生機能によって時間差コピーのページ パッチが利用できます。時間差コピーに対してページ パッチが必要であることが検知されると、ログが自動的に時間差コピーに対して再生され、ページ パッチが実行されます。時間差コピーでは、低ディスク容量のしきい値に達した場合、および時間差コピーが特定の時間帯において唯一の利用可能なコピーであると検知された場合にも、この自動再生機能が呼び出されます。

遅延コピーのログ再生動作は既定では無効で、有効にするには次のコマンドを実行します。

    Set-DatabaseAvailabilityGroup <DAGName> -ReplayLagManagerEnabled $true

有効にすると、コピーが 3 つ未満の場合にログ再生が発生します。次の DWORD レジストリ値を変更することで、既定値の 3 を変更できます。

**HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\Replay\\Parameters\\ReplayLagManagerNumAvailableCopies**

低ディスク容量のしきい値に対するログ再生を有効にするには、次のレジストリ エントリを構成する必要があります。

**HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\Replay\\Parameters\\ReplayLagLowSpacePlaydownThresholdInMB**

これらのレジストリ設定を構成した後、Microsoft Exchange DAG 管理サービスを再開して、変更を有効にします。

例として、特定のデータベースにコピーが 4 つ (3 つの高可用コピーと 1 つの時間差コピー) があり、ReplayLagManagerNumAvailableCopies の既定の設定が使用されている環境を考えます。何らかの理由 (一時停止など) により時間差でないコピーのサービスが停止していると、自動的に時間差コピーが 24 時間内のログ ファイルを再生します。

`ReplayLagManagerEnabled` パラメーターを有効化せずに時間差コピーを使用する場合、以下の点に注意してください。

  - 再生の時間差は管理者によって構成され、既定では無効です。

  - 再生の時間差設定は既定で 0 日で、最大値は 14 日です。

  - 時間差コピーは高可用コピーとは見なされません。時間差コピーは障害復旧を目的としていて、ストアの論理的破損に対する保護を行います。

  - 再生の時間差設定が大きくなればなるほど、データベースの復旧処理も長くなります。復旧時に再生が必要となるログ ファイルの個数、およびハードウェアがログ ファイルを再生する速度に応じて、データベースの復旧には数時間からそれより長い時間を要します。

  - 全体的な障害復旧戦略にとって、時間差コピーが必要不可欠であるかどうかを判断することを推奨します。時間差コピーの使用が戦略上必要不可欠であれば、複数の時間差コピーを使用するか、複数の時間差コピーを使用しないのであれば RAID (Redundant Array of Independent Disks) を使用して単一の時間差コピーを保護することを推奨します。 ディスクを失うか、破損が発生しても、すぐに時間差コピーを失うことはありません。

  - 時間差コピーは、ESE 単一ページ復元機能で修正することはできません。時間差コピーでデータベース ページ破損が発生した場合 (-1018 エラーなど)、再シードが必要になります (これにより、コピーの時間差は失われます)。

データベースですべてのログ ファイルを再生し、データベース コピーを最新にするには、時間差メールボックス データベース コピーをアクティブにして復旧するのが簡単な方法です。ログ ファイルを特定の時点まで再生する場合は、ログ ファイルを手動で操作して Exchange Server データベース ユーティリティ (Eseutil.exe) を実行する必要があるため、複雑な処理になります。

遅延メールボックス データベース コピーをアクティブにする方法の詳細については、「[遅延メールボックス データベース コピーをアクティブにする](activate-a-lagged-mailbox-database-copy-exchange-2013-help.md)」を参照してください。

## 切り捨ての時間差

切り捨ての時間差とは、メールボックス データベース コピーのプロパティであり、ログ ファイルがデータベース コピーに再生されてから、データベース コピーのログが削除されるまでの時間を分で指定します。切り捨ての時間差タイマーは、ログ ファイルがパッシブ コピーに複製され、検査に合格し、データベースのコピーに正常に再生された時点から開始します。データベース コピーからログ ファイルの切り捨てを遅らせることで、データベースのアクティブ コピーのログ ファイルに影響を与える障害から復旧できるようになります。

## データベース コピーとログの切り捨て

ログの切り捨ては、Exchange 2013 でも Exchange 2010 と同じように機能します。切り捨て動作は、コピーの再生の時間差と切り捨ての時間差設定によって決定します。

時間差設定が既定値である 0 (無効) に設定されている場合、データベース コピーのログ ファイルが切り捨てられるには、以下の基準に一致する必要があります。

  - ログ ファイルが正常にバックアップされている必要があるか、循環ログが有効になっている必要があります。

  - ログ ファイルがデータベースのチェックポイント (復旧に必要な最小ログ ファイル) 未満である必要があります。

  - すべてのその他の時間差コピーが、ログ ファイルを検査している必要があります。

  - すべての他のコピー (時間差のないコピー) は、ログ ファイルを再生している必要があります。

時間差データベース コピーで切り捨てが行われるには、以下の基準に一致する必要があります。

  - ログ ファイルがデータベースのチェックポイント未満である必要があります。

  - ログ ファイルが ReplayLagTime + TruncationLagTime より古い必要があります。

  - ログ ファイルがアクティブ コピーで切り捨てられている必要があります。

Exchange 2013 では、1 つ以上のパッシブ コピーが中断状態の場合、アクティブなメールボックス データベース コピーに対してログの切り詰めが行われません。計画された保守作業に長期間 (数日など) かかる場合は、ログ ファイルが大量に蓄積することがあります。ログ ドライブがトランザクション ログで満杯になることを防止するには、影響を受けたパッシブ データベース コピーを中断するのではなく削除します。計画された保守が完了したら、パッシブ データベース コピーを再度追加できます。

Exchange 2013 Service Pack 1 (SP1) には*緩やかな切り捨て*という新機能が導入されていますが、既定では無効です。通常の運用では、各データベース コピーが他のデータベース コピーに移す必要があるログを、すべてのデータベースのコピーがログ ファイルを再生 (パッシブ コピー)または受信 (時間差コピー) したことが確認されるまで保持します。これは、既定のログの切り詰めの動作です。あるデータベース コピーが何らかの理由でオフラインになると、他のデータベース コピーで使用されるディスク上でログ ファイルが蓄積されていきます。当該データベース コピーが長期にわたってオフラインのままになると、他のデータベース コピーがディスク スペースを使い尽くす可能性があります。

緩やかな切り捨てが有効になっている場合は、切り捨て動作が異なります。各データベース コピーは、それ自身のディスク空き領域を追跡して、空き領域が少なくなった場合に緩やかな切り捨て動作を適用します。アクティブ コピーの場合は、最も古い残存コピー (ログ再生が最も後回しのパッシブ データベース コピー) が無視され、切り捨てで残りの最も古いパッシブ コピーが尊重されます。アクティブ データベース コピーでは、グローバル切り捨てが計算されます。パッシブ コピーはアクティブ コピーに対する切り捨ての決定を尊重しようとします。MinCopiesToProtect という名前の意味に反して、Exchange は切り捨ての実行時に最も古い既知の残存コピーだけを無視します。パッシブ コピーの場合は、空き領域不足になった場合に、後述する構成済みのパラメーターを使用してログ ファイルが自主的に切り捨てられます。

オフラインのデータベースがオンラインに戻ると、他の正常なコピーから削除されたログ ファイルがないので、そのデータベース コピーの状態は FailedAndSuspended になります。この場合、Autoreseed が構成されていると、当該コピーは自動的に再シードされます。Autoreseed が構成されていない場合は、管理者がデータベース コピーを手動でシードする必要があります。

必要な正常コピーの数、空きディスク スペースのしきい値、保持されるログの数は、すべて構成可能パラメーターです。既定で、ディスクの空き領域のしきい値は 204800 MB (200 GB) で、保持されるログの数はパッシブ コピーが 100,000 (100 GB)、アクティブ コピーが 10,000 (10 GB) です。

緩やかな切り捨てを有効にし、緩やかな切り捨てパラメーターを構成するには、各 DAG メンバー上で Windows レジストリを編集します。構成できるレジストリ値は 3 つあり、すべて HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\BackupInformation の下に格納されています。次の DWORD 値を持つ BackupInformation キーは既定で存在しないため、手動で作成する必要があります。以下の表で、BackupInformation の下の DWORD レジストリ値について説明します。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>レジストリ値</th>
<th>説明</th>
<th>既定値</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>LooseTruncation_MinCopiesToProtect</p></td>
<td><p>このキーは緩やかな切り捨てを有効にするために使用されます。データベースのアクティブ コピーに対する緩やかな切り捨てから保護されるパッシブ コピーの数を表しています。このキーの値を 0 に設定すると、緩やかな切り捨てが無効になります。</p></td>
<td><p>0</p></td>
</tr>
<tr class="even">
<td><p>LooseTruncation_MinDiskFreeSpaceThresholdInMB</p></td>
<td><p>緩やかな切り捨てのトリガーに使用可能なディスク領域 (MB) のしきい値。空きディスク スペースがこの値より小さくなると、切り詰めがトリガーされます。</p></td>
<td><p>このレジストリ値が構成されていない場合は、緩やかな切り捨てに使用される既定値が 200 GB になります。</p></td>
</tr>
<tr class="odd">
<td><p>LooseTruncation_MinLogsToProtect</p></td>
<td><p>ログが切り捨てられる正常なコピーに関して保持されるログ ファイルの最小数。このレジストリ値が構成されている場合は、構成された値がアクティブ コピーとパッシブ コピーの両方に適用されます。</p></td>
<td><p>このレジストリ値が構成されていない場合は、パッシブ データベース コピーには 100,000 という既定値が、アクティブ データベース コピーには 10,000 という既定値が使用されます。</p></td>
</tr>
</tbody>
</table>


LooseTruncation\_MinLogsToProtect レジストリ値を使用する場合は、アクティブ データベース コピーとパッシブ データベース コピーで動作が異なることに注意してください。アクティブ データベース コピーでは、これは保護されるパッシブ コピーで必要なログとアクティブ コピーの必須範囲で必要なログより前に保持される追加ログの数です。パッシブ データベース コピーでは、最新の使用可能なログから保持されるログの数です。この値の 10 分の 1 が、このパッシブ コピーの必須範囲より前にログを保持するためにも使用されます。時間差データベース コピーの必須範囲は非常に広いことが多いため、このコピーが領域を使いすぎないようにするために 2 つの制限が設けられています。

## データベースのアクティブ化ポリシー

次の例のように、メールボックス データベース コピーを作成し、障害時にそのコピーを自動的にアクティブにしないようにするシナリオが存在します。

  - 1 つまたは複数のメールボックス データベース コピーを代替のデータ センターまたはスタンバイのデータ センターに展開する場合。

  - 回復用に時間差データベース コピーを構成する場合。

  - 保守やサーバーのアップグレードを実行している場合。

上記の各シナリオでは、データベース コピーを自動的にアクティブにすることはできません。メールボックス データベース コピーが自動的にアクティブにならないようにするため、アクティベーションを禁止 (中断) するようにコピーを構成できます。これにより、ログの配布と再生を通じてデータベースを最新に保ちつつ、システムがコピーを自動的にアクティブにして使用することを防ぐことができます。アクティベーションが禁止されたコピーは、管理者が手動でアクティブにする必要があります。データベース アクティベーション ポリシーを、サーバー全体に対して構成する場合は [Set-MailboxServer](https://technet.microsoft.com/ja-jp/library/aa998651\(v=exchg.150\)) コマンドレットを使用し、個々のデータベース コピーに対して構成する場合は [Set-MailboxDatabaseCopy](https://technet.microsoft.com/ja-jp/library/dd298104\(v=exchg.150\)) コマンドレットを使用して *DatabaseCopyAutoActivationPolicy* パラメーターを Blocked に設定します。

データベースのアクティベーション ポリシーの構成の詳細については、「[メールボックス データベースのコピーのライセンス認証ポリシーを構成する](configure-activation-policy-for-a-mailbox-database-copy-exchange-2013-help.md)」を参照してください。

## メールボックスの移動の連続レプリケーションへの影響

アクセス回数が非常に多く、ログ生成率の高いメールボックス データベースでは、パッシブ データベース コピーのレプリケーションがログ生成に間に合わない場合に、データが損失する可能性が高くなります。ログ生成率が高くなるシナリオの 1 つにメールボックスの移動があります。Exchange 2013 にはデータ保証 API が組み込まれており、この API は、システムまたは管理者によって設定された *DataMoveReplicationConstraint* パラメーターの値に基づいてデータベース コピー アーキテクチャの正常性を確認する Microsoft Exchange メールボックス レプリケーション サービス (MRS) などのサービスで使用されます。具体的には、データ保証 API を使用すると以下のような作業が可能になります。

  - **レプリケーションの正常性の確認**   必要な数のデータベース コピーが利用可能であることを確認します。

  - **レプリケーション フラッシュの確認**   必要な数のデータベース コピーに対して必要なログ ファイルが再生されたかどうかを確認します。

実行すると、API は呼び出し元のアプリケーションに次の状態情報を返します。

  - **Retry**   データベースに対する条件の確認を妨げる一時エラーが発生したことを示します。

  - **Satisfied**   データベースが必要な条件を満たしている、またはデータベースがレプリケーションされていないことを示します。

  - **NotSatisfied**   データベースが必要条件を満たしていないことを示します。さらに、**NotSatisfied** 応答が返された理由に関する情報を、呼び出し元のアプリケーションに提供します。

メールボックス データベースの *DataMoveReplicationConstraint* パラメーター値によって、要求の一部として評価するデータベース コピー数が決定されます。*DataMoveReplicationConstraint* パラメーターには、以下の値を指定できます。

  - `None`   メールボックス データベースを作成する際に、既定でこの値が設定されます。この値を設定すると、データ保証 API の条件は無視されます。この設定は、レプリケートされないメールボックス データベースにのみ使用します。

  - `SecondCopy`   これは、メールボックス データベースに 2 つ目のコピーを追加した際に使用される既定値です。この値を設定する場合、少なくとも 1 つのパッシブ データベース コピーがデータ保証 API の条件を満たしている必要があります。

  - `SecondDatacenter`   この値を設定する場合、別の Active Directory サイトにある少なくとも 1 つのパッシブ データベース コピーがデータ保証 API の条件を満たしている必要があります。

  - `AllDatacenters`   この値を設定する場合、各 Active Directory サイトにある少なくとも 1 つのパッシブ データベース コピーがデータ保証 API の条件を満たしている必要があります。

  - `AllCopies`   この値を設定する場合、すべてのメールボックス データベースがデータ保証 API の条件を満たしている必要があります。

**レプリケーションの正常性の確認**

データベース コピーのインフラストラクチャの正常性を評価するためにデータ保証 API が実行されると、いくつかのアイテムが評価されます。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th><em>DataMoveReplicationConstraint</em> パラメーターの設定値</th>
<th>データベースの状態</th>
<th>条件</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><code>SecondCopy</code></p></td>
<td><p>レプリケートされたデータベースの少なくとも 1 つのパッシブ データベース コピーが、次の列の条件を満たす必要があります。</p></td>
<td><p>パッシブ データベース コピーは、次の条件を満たす必要があります。</p>
<ul>
<li><p>正常である。</p></li>
<li><p>再生キューの再生ラグ タイムが 10 分以内である。</p></li>
<li><p>コピー キューの長さが 10 ログ未満である。</p></li>
<li><p>コピー キューの平均の長さが 10 ログ未満である。コピー キューの平均の長さは、アプリケーションによるデータベースの状態の問い合わせ回数に基づいて算出されます。</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p><code>SecondDatacenter</code></p></td>
<td><p>別の Active Directory サイトの少なくとも 1 つのパッシブ データベース コピーが、次の列の条件を満たす必要があります。</p></td>
<td></td>
</tr>
<tr class="odd">
<td><p><code>AllDatacenters</code></p></td>
<td><p>アクティブ コピーがマウントされ、各 Active Directory サイトのパッシブ コピーが、次の列の条件を満たす必要があります。</p></td>
<td></td>
</tr>
<tr class="even">
<td><p><code>AllCopies</code></p></td>
<td><p>アクティブ コピーがマウントされ、すべてのパッシブ データベース コピーが、次の列の条件を満たす必要があります。</p></td>
<td></td>
</tr>
</tbody>
</table>


**レプリケーション フラッシュの確認**

データ保証 API は、必要な数のデータベース コピーが必要なトランザクション ログを再生したことを検証するためにも使用できます。この検証作業は、最後のログ再生のタイムスタンプと、呼び出し元のサービスのコミット タイムスタンプ (ほとんどの場合、これは、必要なデータを含む最後のログ ファイルのタイムスタンプです) に 5 秒 (システム タイム クロックのスキューまたはドリフトに対応するため) を足したものを比較することで行われます。再生タイムスタンプがコミット タイムスタンプより値が大きい場合、*DataMoveReplicationConstraint* パラメーターは満たされます。再生タイムスタンプがコミット タイムスタンプより値が小さい場合、*DataMoveReplicationConstraint* パラメーターは満たされません。

膨大な量のメールボックスを DAG 内のレプリケーション データベースとの間で移動する場合は、事前に各メールボックス データベース上で *DataMoveReplicationConstraint* パラメーターを次のように設定しておくことをお勧めします。


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>展開する対象</th>
<th>DataMoveReplicationConstraint の設定値</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>データベース コピーを持たないメールボックス データベース</p></td>
<td><p><code>None</code></p></td>
</tr>
<tr class="even">
<td><p>1 つの Active Directory サイト内の DAG</p></td>
<td><p><code>SecondCopy</code></p></td>
</tr>
<tr class="odd">
<td><p>分散されている Active Directory サイトを使用する複数のデータ センター内の DAG</p></td>
<td><p><code>SecondCopy</code></p></td>
</tr>
<tr class="even">
<td><p>2 つの Active Directory サイトにまたがる DAG。各サイトに可用性の高いデータベース コピーを保存する。</p></td>
<td><p><code>SecondDatacenter</code></p></td>
</tr>
<tr class="odd">
<td><p>2 つの Active Directory サイトにまたがる DAG。2 つ目のサイトに時間差データベース コピーのみを保存する。</p></td>
<td><p><code>SecondCopy</code></p>
<p>これは、データ保証 API は、ログ ファイルがデータベース コピーに再生されるまでコミット中のデータを保証しないためであり、遅延中のデータベース コピーの性質上、時間差データベース コピーの ReplayLagTime 値が 30 分未満でない場合、この制約により移動要求は失敗します。</p></td>
</tr>
<tr class="even">
<td><p>3 つまたはそれ以上の Active Directory サイトにまたがる DAG。各サイトには可用性の高いデータベース コピーが保存される。</p></td>
<td><p><code>AllDatacenters</code></p></td>
</tr>
</tbody>
</table>


## データベース コピーのバランス維持

DAG 本来の性質から、データベースの切り替えとフェールオーバーの結果として、アクティブなメールボックス データベース コピーによって DAG の有効期間内に何回かホストが変更されます。この結果、アクティブなメールボックス データベース コピー配布の点で DAG のバランスがくずれる可能性があります。次の表に、アクティブなデータベース コピーが不均等に配布された、それぞれに各データベースの 4 つのコピーを持つ 4 つのデータベースがある DAG (各サーバーに合計 16 個のデータベース) の例を示します。

### バランスがくずれたアクティブなコピー配布を持つ DAG

<table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>サーバー</th>
<th>アクティブなデータベースの数</th>
<th>パッシブなデータベースの数</th>
<th>マウントされたデータベースの数</th>
<th>マウント解除されたデータベースの数</th>
<th>優先順位カウント一覧</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>EX1</p></td>
<td><p>5</p></td>
<td><p>11</p></td>
<td><p>5</p></td>
<td><p>0</p></td>
<td><p>4, 4, 3, 5</p></td>
</tr>
<tr class="even">
<td><p>EX2</p></td>
<td><p>1</p></td>
<td><p>15</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>1, 8, 6, 1</p></td>
</tr>
<tr class="odd">
<td><p>EX3</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>0</p></td>
<td><p>13, 2, 1, 0</p></td>
</tr>
<tr class="even">
<td><p>EX4</p></td>
<td><p>1</p></td>
<td><p>15</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>1, 1, 5, 9</p></td>
</tr>
</tbody>
</table>


前の例では、各データベースの 4 つのコピーがあるため、アクティブ化優先順位に指定できる値は 4 つ (1、2、3、または 4) しかありません。**「優先順位カウント一覧」** 列は、アクティブ化優先順位の値ごとにデータベース数のカウントを示したものです。たとえば、EX3 には、アクティブ化優先順位が 1 のデータベース コピーが 13 個、アクティブ化優先順位が 2 のコピーが 2 個、アクティブ化優先順位が 3 のコピーが 1 個あり、アクティブ化優先順位が 4 のコピーはありません。

ご覧のとおり、この DAG は、各 DAG メンバーによってホストされているアクティブなデータベースの数、各 DAG メンバーによってホストされているパッシブなデータベースの数、またはホストされているデータベースのアクティブ化優先順位カウントの点でバランスがくずれています。

RedistributeActiveDatabases.ps1 スクリプトを使用すると、DAG 全体にわたってアクティブなメールボックス データベース コピーのバランスを維持できます。このスクリプトは、DAG 内の各サーバーにマウントされているデータベースの数を均等にするために、データベースをコピー間で移動します。必要に応じて、サイト全体でアクティブなデータベースのバランスをとることも試行します。

このスクリプトには、DAG 内でアクティブなデータベース コピーのバランスをとるために、次の 2 つのオプションが用意されています。

  - **BalanceDbsByActivationPreference**   このオプションを指定すると、スクリプトは Active Directory サイトを無視して、データベースをその最も優先されるコピー (アクティブ化優先順位に基づき) に移動しようとします。

  - **BalanceDbsBySiteAndActivationPreference**   このオプションを指定すると、スクリプトは各 Active Directory サイト内のアクティブなデータベースのバランスをとる一方で、アクティブなデータベースをその最も優先されるコピーに移動しようとします。

最初のオプションでスクリプトを実行すると、次の表に示すように、前述のバランスがくずれた DAG のバランスが調整されます。

### バランスがとれたアクティブなコピー配布を持つ DAG

<table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>サーバー</th>
<th>アクティブなデータベースの数</th>
<th>パッシブなデータベースの数</th>
<th>マウントされたデータベースの数</th>
<th>マウント解除されたデータベースの数</th>
<th>優先順位カウント一覧</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>EX1</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
<tr class="even">
<td><p>EX2</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
<tr class="odd">
<td><p>EX3</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
<tr class="even">
<td><p>EX4</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
</tbody>
</table>


前の表に示したように、この DAG は、各サーバー上のアクティブとパッシブなデータベースの数、およびサーバー全体にわたるアクティブ化優先順位の点でバランスがとれた状態になりました。

次の表に、RedistributeActiveDatabases.ps1 スクリプトで使用可能なパラメーターを示します。

### RedistributeActiveDatabases.ps1 スクリプトのパラメーター

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>パラメーター</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>DagName</em></p></td>
<td><p>再度バランスをとる DAG の名前を指定します。このパラメーターを省略すると、ローカル サーバーがメンバーになっている DAG が使用されます。</p></td>
</tr>
<tr class="even">
<td><p><em>BalanceDbsByActivationPreference</em></p></td>
<td><p>Active Directory サイトを無視してデータベースをその最も優先されるコピーに移動するようにスクリプトに指定します。</p></td>
</tr>
<tr class="odd">
<td><p><em>BalanceDbsBySiteAndActivationPreference</em></p></td>
<td><p>Active Directory サイト内のアクティブなデータベースのバランスをとる一方で、アクティブなデータベースをその最も優先されるコピーに移動するようにスクリプトに指定します。</p></td>
</tr>
<tr class="even">
<td><p><em>ShowFinalDatabaseDistribution</em></p></td>
<td><p>現在のデータベース配布のレポートを再配布の完了後に表示するように指定します。</p></td>
</tr>
<tr class="odd">
<td><p><em>AllowedDeviationFromMeanPercentage</em></p></td>
<td><p>サイト全体におけるアクティブなデータベースの許容変化量を割合で指定します。既定値は 20% です。たとえば、3 つのサイト間に 99 個のデータベースが配布されている場合、最適な配布は各サイトで 33 個のデータベースとなります。許容変化量が 20% の場合、各サイトでこの個数の上下 10% を超えないように、スクリプトはデータベースのバランスをとろうとします。33 の 10% は 3.3 で、切り上げて 4 になります。したがって、スクリプトは各サイトでデータベースの数を 29 ～ 37 にしようとします。</p></td>
</tr>
<tr class="even">
<td><p><em>ShowDatabaseCurrentActives</em></p></td>
<td><p>各データベースについて、データベースがどのように移動したか、データベースがその最も優先されるコピーでアクティブであるかどうかを詳細に示すレポートを生成するようにスクリプトに指定します。</p></td>
</tr>
<tr class="odd">
<td><p><em>ShowDatabaseDistributionByServer</em></p></td>
<td><p>各サーバーについて、そのデータベース配布を示すレポートを生成するようにスクリプトに指定します。</p></td>
</tr>
<tr class="even">
<td><p><em>RunOnlyOnPAM</em></p></td>
<td><p>現在 PAM 役割を持つ DAG メンバー上でのみスクリプトを実行するように指定します。スクリプトは、PAM から実行されていることを確認します。PAM から実行されていない場合、スクリプトは終了します。</p></td>
</tr>
<tr class="odd">
<td><p><em>LogEvents</em></p></td>
<td><p>アクションの概要を含むイベント (MsExchangeRepl イベント 4115) をログに記録するようにスクリプトに指定します。</p></td>
</tr>
<tr class="even">
<td><p><em>IncludeNonReplicatedDatabases</em></p></td>
<td><p>アクティブなデータベースの再配布方法の決定時に、レプリケートされていないデータベース (コピーを持たないデータベース) を含めるようにスクリプトに指定します。レプリケートされていないデータベースは移動できませんが、レプリケートされたデータベースの配布に影響を与える場合があります。</p></td>
</tr>
<tr class="odd">
<td><p><em>Confirm</em></p></td>
<td><p>Confirm スイッチは、このスクリプトの実行時に既定で表示される確認プロンプトの表示の抑制に使用できます。確認プロンプトの表示を抑制するには、syntax -Confirm:$False を使用します。この構文にはコロン (:) を含める必要があります。</p></td>
</tr>
</tbody>
</table>


## RedistributeActiveDatabases.ps1 の例

この例は、優先順位カウント一覧を含む DAG の現在のデータベース配布を示します。

    RedistributeActiveDatabases.ps1 -DagName DAG1 -ShowDatabaseDistributionByServer | Format-Table

この例では、入力を促すメッセージを表示しないで、アクティブ化優先順位を使用して、DAG 内のアクティブなメールボックス データベース コピーを再配布しバランスをとります。

    RedistributeActiveDatabases.ps1 -DagName DAG1 -BalanceDbsByActivationPreference -Confirm:$False

この例では、アクティブ化優先順位を使用して、DAG 内のアクティブなメールボックス データベース コピーを再配布しバランスをとり、配布の概要を生成します。

    RedistributeActiveDatabases.ps1 -DagName DAG1 -BalanceDbsByActivationPreference -ShowFinalDatabaseDistribution

## データベース コピーの監視

データベース コピーは、データベースのアクティブ コピーに影響を与える障害が発生した場合の、第一の防御です。このため、データベース コピーの正常性と状態を監視し、必要なときに利用できることを確認することは必要不可欠です。EAC でデータベース コピーの詳細を確認することで、コピー キューの長さ、再生キューの長さ、状態とコンテンツ インデックス状態情報などのさまざまな情報を表示できます。シェルで **Get-MailboxDatabaseCopyStatus** コマンドレットを使用しても、データベース コピーに関するさまざまな状態情報を表示できます。

データベース コピーの監視の詳細については、「[データベース可用性グループの監視](monitoring-database-availability-groups-exchange-2013-help.md)」を参照してください。

## データベース コピーの削除

EAC を使用するか、シェルで **Remove-MailboxDatabaseCopy** コマンドレットを使用すれば、いつでもデータベース コピーを削除できます。データベース コピーを削除した後、データベース コピーを削除するサーバーからすべてのデータベースとトランザクション ログ ファイルを手動で削除する必要があります。データベース コピーを削除する方法の詳細については、「[メールボックス データベース コピーを削除する](remove-a-mailbox-database-copy-exchange-2013-help.md)」を参照してください。

## データベース切り替え

データベースのアクティブ コピーをホストするメールボックス サーバーはメールボックス データベース マスターと呼ばれます。パッシブ データベース コピーをアクティブにする処理により、データベースのメールボックス データベース マスターが変更され、パッシブ コピーが新しいアクティブ コピーに変わります。この処理をデータベースの切り換えと呼びます。データベースの切り替えでは、1 つのメールボックス サーバー上のデータベースのアクティブ コピーがマウント解除され、そのデータベースのパッシブ コピーが別のメールボックス サーバー上で新しいアクティブ メールボックス データベースとしてマウントされます。切り替え実行時には、オプションで新しいメールボックス データベース マスターのデータベース マウント ダイヤル設定を上書きできます。

EAC の <strong>データベース コピー</strong> タブの下にある右側の列を確認することで、どのメールボックス サーバーが現在のメールボックス データベース マスターであるかを素早く特定することができます。EAC で <strong>アクティブにする</strong> リンクを使用するか、シェルで **Move-ActiveMailboxDatabase** コマンドレットを使用することで、切り替えを実行できます。

パッシブ コピーをアクティブにする前に、いくつかの内部チェックが実行されます。

  - データベース コピーの状態がチェックされます。データベース コピーが障害状態にあると、切り替えは禁止されます。**Move-ActiveMailboxDatabase** コマンドレットの *SkipHealthChecks* パラメーターを使用することで、この動作を無効にして、正常性のチェックをバイパスできます。このパラメーターを使用することで、障害状態にあるデータベース コピーにアクティブ コピーを移動できます。

  - アクティブ データベース コピーが、現在、データベースのいずれかのパッシブ コピーのシード元であるかどうかを確認するためにチェックされます。アクティブ コピーが現在シード元として使用されている場合は、切り替えはブロックされます。**Move-ActiveMailboxDatabase** コマンドレットの *SkipActiveCopyChecks* パラメーターを使用することで、この動作を無効にして、シード元のチェックをバイパスできます。このパラメーターを使用して、シード元として使用されているアクティブ コピーを移動できます。このパラメーターを使用すると、シード処理がキャンセルされ、失敗となります。

  - データベース コピーのコピー キューと再生キューの長さがチェックされ、これらの値が構成された基準の範囲内にあることが確認されます。また、データベース コピーが確認され、現在シードのシード元として使用されていないことが確認されます。キューの長さの値が構成された範囲外にある場合、またはデータベースが現在シードのシード元として使用されている場合、切り替えは禁止されます。**Move-ActiveMailboxDatabase** コマンドレットの *SkipLagChecks* パラメーターを使用することで、この動作を無効にして、これらのチェックをバイパスできます。このパラメーターは、アクティブ化され、再生とコピーのキューを持つコピーが、構成された条件外になることを許可します。

  - データベース コピーの検索カタログ (コンテンツ インデックス) の状態がチェックされます。検索カタログが最新ではない場合、異常な状態にある場合、または破損している場合、切り替えは禁止されます。**Move-ActiveMailboxDatabase** コマンドレットの *SkipClientExperienceChecks* パラメーターを使用することで、この動作を無効にして、検索カタログのチェックをバイパスできます。このパラメーターを使用すると、この検索はカタログの正常性チェックをスキップします。アクティブにするデータベース コピーの検索カタログが異常、または使用不可能な状態にあり、このパラメーターを使用してカタログの正常性チェックをスキップしてデータベース コピーをアクティブにする場合、検索カタログを再度クロールするか、シードする必要があります。

データベース切り替えを実行するとき、アクティブにするパッシブ データベース コピーをホストするサーバーに構成されているマウント ダイヤル設定を上書きする方法もあります。**Move-ActiveMailboxDatabase** コマンドレットの *MountDialOverride* パラメーターを使用することで、マウント ダイヤル設定を無視して、*MountDialOverride* パラメーターで指定された値を使用するように移動先サーバーに指示します。

データベース コピーの切り替え方法の詳細な手順については、「[メールボックス データベース コピーをアクティブにする](activate-a-mailbox-database-copy-exchange-2013-help.md)」を参照してください。

