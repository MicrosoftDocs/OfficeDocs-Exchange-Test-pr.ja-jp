---
title: 'セーフティ ネット: Exchange 2013 Help'
TOCTitle: セーフティ ネット
ms:assetid: d0abb807-3b12-4c7d-bc7e-769b87c84ccb
ms:mtpsurl: https://technet.microsoft.com/ja-jp/library/JJ657495(v=EXCHG.150)
ms:contentKeyID: 49896486
ms.date: 04/24/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# セーフティ ネット

 

_**適用先:** Exchange Server 2013_

_**トピックの最終更新日:** 2015-03-09_

Microsoft Exchange Server 2013 におけるメールボックス高可用性の主要なメカニズムは、データベース可用性グループ (DAG) です。DAG の詳細については、「[データベース可用性グループの管理](managing-database-availability-groups-exchange-2013-help.md)」を参照してください。*トランスポート収集*は最初に Exchange 2007 に導入され、Exchange 2010 においてさらに改善され、DAG のメールボックスに正常に配信された後のメッセージの冗長コピーが提供されました。Exchange 2010 では、トランスポート収集は、DAG のパッシブ メールボックス データベース コピーにレプリケートされなかった、正常に配信されたメッセージのキューを維持することにより、データを損失をしないようにしました。メールボックス データベースまたはメールボックス サーバーの障害により、メールボックス データベースの古いコピーの昇格が必要になった場合は、トランスポート収集内のメッセージが、メールボックス データベースの新しいアクティブ コピーに自動的に再送信されます。

トランスポート収集は Exchange 2013 において改善されており、現在は*セーフティ ネット*と呼ばれています。

次に、セーフティ ネットと Exchange 2010 のトランスポート収集における類似点を示します。

  - セーフティ ネットは、メールボックス サーバー上のトランスポート サービスに関連付けられたキューです。このキューにより、サーバーによって正常に処理されたメッセージのコピーが保存されます。

  - 期限切れになり、自動的に削除されるまで、セーフティ ネットが正常に処理されたメッセージのコピーを保存する時間を指定できます。既定値は 2 日です。

次に、Exchange 2013 におけるセーフティ ネットの相違点を示します。

  - セーフティ ネットは DAG を必要としません。DAG に属していないメールボックス サーバーの場合は、セーフティ ネットにより、配信されたメッセージのコピーがローカルの Active Director サイトにある他のメールボックス上に保存されます。

  - 現在は、セーフティ ネット自体が冗長性を備えており、単一障害点ではなくなりました。これにより、*プライマリ セーフティ ネット*および*シャドウ セーフティ ネット*の概念が導入されます。プライマリ セーフティ ネットが 12 時間を超える時間にわたって使用不可になった場合は、再送信要求がシャドウ再送信要求になり、メッセージはシャドウ セーフティ ネットから再配信されます。

  - セーフティ ネットは、DAG 環境におけるシャドウ冗長性から一部の責任を引き継ぎます。シャドウ冗長性は、配信されたメッセージの別のコピーをシャドウ キューに保持する必要がなく、その一方で、配信されたメッセージが DAG の他のメールボックス サーバー上のメールボックス データベースのパッシブ コピーにレプリケートされるまで待機します。配信されたメッセージのコピーは既にセーフティ ネットに保存されているため、必要な場合は、メッセージをセーフティ ネットから再送信できます。

  - Exchange 2013 では、トランスポート高可用性はメッセージの冗長性の最大を超えています。Exchange 2013 は、メッセージの冗長性を保証しようとします。そのため、セーフティ ネットの最大サイズ制限は指定できません。指定できるのは、自動的に削除されるまでセーフティ ネットがメッセージを保存する時間だけです。

**目次**

セーフティ ネットの機能

セーフティ ネットからのメッセージの再送信

シャドウ セーフティ ネットからのメッセージの再送信

## セーフティ ネットの機能

シャドウ冗長性によりメッセージの冗長コピーが保持され、同時に、そのメッセージは送信中になります。メッセージが正常に処理された後には、セーフティ ネットによりメッセージの冗長コピーが保持されます。したがって、セーフティ ネットが開始されるとシャドウ冗長性は終了します。シャドウ冗長性に関する同じ概念 (トランスポート高可用性境界、プライマリ メッセージ、プライマリ サーバー、シャドウ メッセージ、シャドウ サーバーを含む) は、セーフティ ネットにも適用されます。詳細については、「[シャドウ冗長](shadow-redundancy-exchange-2013-help.md)」を参照してください。

プライマリ セーフティ ネットは、トランスポート サービスによってメッセージが正常に処理される前にプライマリ メッセージを保持していたメールボックス サーバー上に存在します。これは、メッセージが、宛先メールボックス サーバー上のメールボックス トランスポート サービスに配信されたことを意味している可能性があります。または、宛先の DAG または Active Directory サイトへの途中のハブ サイトとして指定された Active Directory サイトにあるメールボックス サーバーを介して、メッセージが中継された可能性があります。プライマリ サーバーによってプライマリ メッセージが処理されると、そのメッセージはアクティブ キューから同じサーバー上のプライマリ セーフティ ネットに移動します。

シャドウ セーフティ ネットは、シャドウ メッセージを保持していたメールボックス サーバー上に存在します。シャドウ サーバーは、プライマリ サーバーによってプライマリ メッセージが正常に処理されたことを判断すると、そのシャドウ メッセージをシャドウ キューから同じサーバー上のシャドウ セーフティ ネットに移動します。これは明白であると思われますが、シャドウ セーフティ ネットが存在するためには、シャドウ冗長性を有効にする必要があり、シャドウ冗長性は Exchange 2013 では既定で有効になっています。

次の表では、セーフティ ネットにより使用されるパラメーターについて説明します。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>パラメーター</th>
<th>既定値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-TransportConfig</strong> の <em>SafetyNetHoldTime</em></p></td>
<td><p>2 日</p></td>
<td><p>正常に処理されたプライマリ メッセージがプライマリ セーフティ ネットに保存される時間の長さ、および確認されたシャドウ メッセージがシャドウ セーフティ ネットに保存される時間の長さ。</p>
<p>この値は、Exchange 管理センター (EAC) の <strong>[メール フロー]</strong> &gt; <strong>[受信コネクタ]</strong> &gt; <strong>[その他のオプション]</strong><img src="images/JJ150550.5381819e-3b21-4873-8714-e9b956290b28(EXCHG.150).gif" title="[その他のオプション] アイコン" alt="[その他のオプション] アイコン" /> &gt; <strong>[組織のトランスポート設定]</strong> &gt; <strong>[セーフティ ネット]</strong> &gt; <strong>[セーフティ ネットの保持期間]</strong> で指定することもできます。</p>
<p>最終的には、<strong>Set-TransportService</strong> における <em>SafetyNetHoldTime</em> と <em>MessageExpirationTimeout</em> の合計が経過すると、確認されたシャドウ メッセージはシャドウ セーフティ ネットから期限切れになります。</p>
<p>セーフティ ネットによる再送信中のデータ損失を防ぐため、<em>SafetyNetHoldTime</em> の値は、メールボックス データベースの被覆コピーの <strong>Set-MailboxDatabaseCopy</strong> における <em>ReplayLagTime</em> の値以上である必要があります。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-MailboxDatabaseCopy</strong> の <em>ReplayLagTime</em></p></td>
<td><p>未構成</p></td>
<td><p>パッシブ データベース コピーの場所にコピーされたログ ファイルを再生する前に、Microsoft Exchange Replication サービスが待機する時間。このパラメーターを 0 よりも大きい値に設定すると、メールボックス データベースの被覆コピーが作成されます。最大値は 14 日です。</p>
<p>セーフティ ネットによる再送信中のデータ損失を防ぐため、<em>ReplayLagTime</em> の値は、メールボックス データベースの被覆コピーの <strong>Set-TransportConfig</strong> における <em>SafetyNetHoldTime</em> の値以下である必要があります。</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-TransportService</strong> の <em>MessageExpirationTimeout</em></p></td>
<td><p>2 日</p></td>
<td><p>期限前にメッセージがキューに残る時間。</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportConfig</strong> の <em>ShadowRedundancyEnabled</em></p></td>
<td><p><code>$true</code></p></td>
<td><ul>
<li><p><code>$true</code> により、組織内のすべてのトランスポート サーバー上でシャドウの冗長性が有効になります。</p></li>
<li><p><code>$false</code> により、組織内のすべてのトランスポート サーバー上でシャドウの冗長性が無効になります。</p></li>
</ul>
<p>冗長セーフティ ネットを使用するには、シャドウ冗長性を有効にする必要があります。</p></td>
</tr>
</tbody>
</table>


ページのトップへ

## セーフティ ネットからのメッセージの再送信

セーフティ ネットからのメッセージの再送信は、DAG およびメールボックス データベース コピーを管理する Microsoft Exchange Replication サービスの Active Manager コンポーネントによって開始されます。セーフティ ネットからのメッセージの再送信では、手動による操作は必要ありません。Active Manager の詳細については、「[アクティブ マネージャー](active-manager-exchange-2013-help.md)」を参照してください。

セーフティ ネットのメッセージ再送信には、2 つの基本的なシナリオがあります。

  - DAG のメールボックス データベースの自動フェールオーバーまたは手動フェールオーバーの後。

  - メールボックス データベースの被覆コピーをアクティブにした後。

*被覆メールボックス データベース コピー*（*被覆コピー*）は、データベースに対する更新を意図的に遅らせることにより、メールボックス データベースの論理的破損を阻止しする、メールボックス データベースのパッシブ コピーです。詳細については、「[メールボックス データベースのコピーの管理](managing-mailbox-database-copies-exchange-2013-help.md)」を参照してください。

2 つのシナリオ間での唯一の大きな違いは、セーフティ ネットからメッセージを再送信するために戻る時間の長さです。一般的に、DAG におけるフェールオーバーの場合、メールボックス データベースの新しいアクティブ コピーは、古いアクティブ コピーよりも数分から数時間前のものです。メールボックス データベースの被覆コピーは一般的に、古いアクティブ コピーよりも数日前のものです。

被覆コピーをセーフティ ネットから正常に再送信するための主な要件は、メッセージがセーフティ ネットに保存される時間が、メールボックス データベースの被覆コピーの時間差以上であることです。言い換えると、**Set-TransportConfig** における *SafetyNetHoldTime* の値は、被覆コピーの **Set-MailboxDatabaseCopy** における *ReplayLagTime* の値以上である必要があります。

ページのトップへ

## シャドウ セーフティ ネットからのメッセージの再送信

プライマリ セーフティ ネットからのメッセージの再送信と同様に、シャドウ セーフティ ネットからのメッセージの再送信は完全に自動化されており、手動での介入は必要ありません。

Active Manager が一定の時間をこえて、セーフティ ネットからのメッセージの再送信を要求すると、この要求は、プライマリ セーフティ ネットが要求された時間メッセージのコピーを保持しているメールボックス サーバー上のトランスポート サービスに移動します。大規模な Exchange 組織では、特に要求された時間が長い場合、複数のメールボックス サーバー上のセーフティ ネットに要求されたメッセージが存在しやすくなります。

最適化を行わないと、セーフティ ネットからのメッセージの再送信により、潜在的な多数の重複配信につながるおそれがあります。重複メッセージの検出により、メッセージの重複コピーはユーザーに対して表示されないため、Exchange 組織内での重複配信は問題になりません。ただし、Exchange 組織外の受信者への重複メッセージの配信は、メッセージの重複コピーにつながります。幸いにも、セーフティ ネットからのメッセージの再送信は Exchange 2013 において最適化されており、重複メッセージの配信が低減されています。

プライマリ セーフティ ネットが最初に応答不能である場合、またはメッセージの再送信中に応答不能になった場合、Active Manager は 12 時間にわたって、プライマリ セーフティ ネットとの通信を試行し続けます。12 時間が経過すると、トランスポート高可用性境界内の全メールボックス サーバー上のトランスポート サービスにブロードキャストが送信され、要求されたメールボックス データベースの要求された時間間隔におけるセーフティ ネットからのメッセージの再送信が要求されます。シャドウ セーフティ ネットは応答すると、要求された時間間隔中のみ、要求されたメールボックス データベースのメッセージを再送信します。

シャドウ セーフティ ネットに保存されるシャドウ メッセージについて、いくつかの重要な注意事項があります。

  - シャドウ セーフティ ネットは、プライマリ サーバーがプライマリ メッセージを転送した場所を認識していません。

  - シャドウ セーフティ ネットのシャドウ メッセージには元のメッセージ エンベロープ受信者のみが含まれており、プライマリ メッセージが配信された実際の受信者は含まれていません。たとえば、メッセージ エンベロープ受信者は、展開を必要とする配布グループである場合があります。

  - シャドウ セーフティ ネットのメッセージには、プライマリ サーバーがメッセージを処理した後に発生したメッセージの更新は含まれていません。たとえば、メッセージ エンコーディングやコンテンツ変換などがあります。

シャドウ セーフティ ネットから再送信されたシャドウ メッセージには、メールボックス サーバー上のトランスポート サービスを介した完全な分類および処理が必要です。シャドウ セーフティ ネットから多数のシャドウ メッセージが再送信された場合は、メールボックス サーバーのリソースという点でコストが高くなる可能性があります。幸いにも、シャドウ セーフティ ネットからのシャドウ メッセージの再送信もまた最適化されているため、要求された時間間隔において、要求されたメールボックス データベースのシャドウ セーフティ ネットのメッセージのみが再送信されます。

次のシナリオでは、メッセージの再送信中におけるプライマリ セーフティ ネットとシャドウ セーフティ ネットのやり取りについて説明します。

1.  Active Manager が、あるメールボックス データベースの午前 5 時～午前 9 時のメッセージを再送信するようセーフティ ネットに要求します。ただし、プライマリ セーフティ ネットがあるメールボックス サーバーは、ハードウェア障害によりクラッシュしています。Active Manager は、12 時間にわたってプライマリ セーフティ ネットとの通信を繰り返し試行します。

2.  12 時間が経過すると、Active Manger は、トランスポート高可用性境界内の全メールボックス サーバー上のトランスポート サービスにブロードキャスト メッセージを送信し、ターゲット メールボックス データベースの午前 5 時～午前 9 時のメッセージを保持している他のセーフティ ネットを検索します。そしてシャドウ セーフティ ネットがそれに応答し、メールボックス データベースの午前 5 時～午前 9 時のメッセージを再送信します。

次のシナリオで説明するように、要求された再送信間隔中にプライマリ セーフティ ネットがオフラインになった場合は、興味深いやり取りが発生します。

1.  プライマリ セーフティ ネットを保持するメールボックス サーバー上のキュー データベースが破損し、新しいキュー データベースが午前 7 時に作成されました。午前 1 時～午前 7 時の間にプライマリ セーフティ ネットに保存されたすべてのプライマリ メッセージは失われますが、午前 7 時以降、サーバーは正常に配信されたメッセージのコピーをセーフティ ネットに保存できます。

2.  Active Manager が、午前 1 時～午前 9 時の時間間隔におけるメールボックス データベースのセーフティ ネットからのメッセージの再送信を要求します。

3.  プライマリ セーフティ ネットは、午前 7 時～午前 9 時の時間間隔におけるメッセージを再送信します。

4.  プライマリ セーフティ ネットは、トランスポート高可用性境界内の全メールボックス サーバー上のトランスポート サービスにブロードキャスト メッセージを送信し、プライマリ セーフティ ネットがメッセージを保持していない間の午前 1 時～午前 7 時の時間間隔におけるターゲット メールボックス データベースのメッセージを含む他のセーフティ ネットを検索します。午前 1 時～ 午前 7 時の時間間隔におけるターゲット メールボックス データベースのシャドウ メッセージを再送信するために、シャドウ セーフティ ネットは、プライマリ セーフティ ネットの代わりに 2 回目の再送信要求を生成します。

セーフティ ネットからメッセージが再送信される場合には、注意するべきその他のいくつかの問題があります。

1.  すべての配信状態通知 (DSN) および配信不能レポート (NDR) は、セーフティ ネットの再送信において抑制されます。たとえば、プライマリ メッセージにより NDR が生成された場合、再送信されたメッセージの NDR は配信されません。

2.  シャドウ セーフティ ネットがメッセージを再送信した場合は、配布グループから削除されたユーザーが、再送信されたメッセージを受信しない場合があります。たとえば、ユーザー A とユーザー B を含むグループにメッセージを送信し、両方の受信者がメッセージを受信します。ユーザー B を、その後グループから削除します。その後、ユーザー B のメールボックスを保持するメールボックス データベースに対して、プライマリ セーフティ ネットからの再送信要求が作成されます。ただし、プライマリ セーフティ ネットは 12 時間を超える時間にわたって使用不可になるため、シャドウ セーフティ ネットが応答し、影響を受けたメッセージを再送信します。配布グループを展開すると、再送信中にはユーザー B はグループのメンバーではないため、ユーザー B は再送信されたメッセージのコピーを受信しません。

3.  シャドウ セーフティ ネットがメッセージを再送信した場合は、配布グループに追加された新しいユーザーが、再送信された古いメッセージを受信する場合があります。たとえば、ユーザー A とユーザー B を含むグループにメッセージを送信し、両方の受信者がメッセージを受信します。ユーザー C を、その後グループに追加します。その後、ユーザー C のメールボックスを保持するメールボックス データベースに対して、プライマリ セーフティ ネットからの再送信要求が作成されます。ただし、プライマリ セーフティ ネット サーバーは 12 時間を超える時間にわたって使用不可になるため、シャドウ セーフティ ネット サーバーが応答し、影響を受けたメッセージを再送信します。配布グループを展開すると、再送信中にはユーザー C はグループのメンバーであるため、ユーザー C は再送信されたメッセージのコピーを受信します。

ページのトップへ

